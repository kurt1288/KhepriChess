(()=>{"use strict";var t={58:t=>{t.exports=require("readline")}},s={};function i(e){var n=s[e];if(void 0!==n)return n.exports;var h=s[e]={exports:{}};return t[e](h,h.exports,i),h.exports}(()=>{var t,s,e,n,h,o;!function(t){t[t.Opening=0]="Opening",t[t.Endgame=1]="Endgame",t[t.MiddleGame=2]="MiddleGame"}(t||(t={})),function(t){t[t.a8=0]="a8",t[t.b8=1]="b8",t[t.c8=2]="c8",t[t.d8=3]="d8",t[t.e8=4]="e8",t[t.f8=5]="f8",t[t.g8=6]="g8",t[t.h8=7]="h8",t[t.a7=8]="a7",t[t.b7=9]="b7",t[t.c7=10]="c7",t[t.d7=11]="d7",t[t.e7=12]="e7",t[t.f7=13]="f7",t[t.g7=14]="g7",t[t.h7=15]="h7",t[t.a6=16]="a6",t[t.b6=17]="b6",t[t.c6=18]="c6",t[t.d6=19]="d6",t[t.e6=20]="e6",t[t.f6=21]="f6",t[t.g6=22]="g6",t[t.h6=23]="h6",t[t.a5=24]="a5",t[t.b5=25]="b5",t[t.c5=26]="c5",t[t.d5=27]="d5",t[t.e5=28]="e5",t[t.f5=29]="f5",t[t.g5=30]="g5",t[t.h5=31]="h5",t[t.a4=32]="a4",t[t.b4=33]="b4",t[t.c4=34]="c4",t[t.d4=35]="d4",t[t.e4=36]="e4",t[t.f4=37]="f4",t[t.g4=38]="g4",t[t.h4=39]="h4",t[t.a3=40]="a3",t[t.b3=41]="b3",t[t.c3=42]="c3",t[t.d3=43]="d3",t[t.e3=44]="e3",t[t.f3=45]="f3",t[t.g3=46]="g3",t[t.h3=47]="h3",t[t.a2=48]="a2",t[t.b2=49]="b2",t[t.c2=50]="c2",t[t.d2=51]="d2",t[t.e2=52]="e2",t[t.f2=53]="f2",t[t.g2=54]="g2",t[t.h2=55]="h2",t[t.a1=56]="a1",t[t.b1=57]="b1",t[t.c1=58]="c1",t[t.d1=59]="d1",t[t.e1=60]="e1",t[t.f1=61]="f1",t[t.g1=62]="g1",t[t.h1=63]="h1",t[t.no_sq=64]="no_sq"}(s||(s={})),function(t){t[t.White=0]="White",t[t.Black=1]="Black",t[t.Both=2]="Both"}(e||(e={})),function(t){t[t.rook=0]="rook",t[t.bishop=1]="bishop"}(n||(n={})),function(t){t[t.wk=1]="wk",t[t.wq=2]="wq",t[t.bk=4]="bk",t[t.bq=8]="bq"}(h||(h={})),function(t){t[t.P=0]="P",t[t.N=1]="N",t[t.B=2]="B",t[t.R=3]="R",t[t.Q=4]="Q",t[t.K=5]="K",t[t.p=6]="p",t[t.n=7]="n",t[t.b=8]="b",t[t.r=9]="r",t[t.q=10]="q",t[t.k=11]="k"}(o||(o={}));const a=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],r=[7,15,15,15,3,15,15,11,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,13,15,15,15,12,15,15,14],c=[0n,1n,2n,3n,4n,5n,6n,7n,8n,9n,10n,11n,12n,13n,14n,15n,16n,17n,18n,19n,20n,21n,22n,23n,24n,25n,26n,27n,28n,29n,30n,31n,32n,33n,34n,35n,36n,37n,38n,39n,40n,41n,42n,43n,44n,45n,46n,47n,48n,49n,50n,51n,52n,53n,54n,55n,56n,57n,58n,59n,60n,61n,62n,63n,64n,65n];let l=1804289383;function p(){let t=l;return t^=t<<13,t^=t>>>17,t^=t<<5,l=t,BigInt.asUintN(32,BigInt(t))}function d(){const t=BigInt.asUintN(64,0xffffn&p()),s=BigInt.asUintN(64,0xffffn&p()),i=BigInt.asUintN(64,0xffffn&p()),e=BigInt.asUintN(64,0xffffn&p());return BigInt.asUintN(64,BigInt(t|s<<16n|i<<32n|e<<48n))}class b{constructor(i){this.name="KhepriChess",this.version="0.6.0",this.author="Kurt Peters",this.bitboards=[0n,0n,0n,0n,0n,0n,0n,0n,0n,0n,0n,0n],this.occupancies=[0n,0n,0n],this.side=-1,this.enpassant=s.no_sq,this.castle=0,this.nodesCount=0,this.gamePhase=t.Opening,this.notAFile=18374403900871474942n,this.notHFile=9187201950435737471n,this.notHGFile=4557430888798830399n,this.notABFile=18229723555195321596n,this.asciiPieces="PNBRQKpnbrqk",this.unicodePieces=["♙","♘","♗","♖","♕","♔","♟︎","♞","♝","♜","♛","♚"],this.moveStack=[],this.pawnAttacks=Array.from(Array(2),(()=>new Array(64))),this.knightAttacks=Array(64),this.kingAttacks=Array(64),this.bishopMasks=Array(64),this.bishopAttacks=Array.from(Array(64),(()=>new Array(512))),this.bishopRelevantBits=[6n,5n,5n,5n,5n,5n,5n,6n,5n,5n,5n,5n,5n,5n,5n,5n,5n,5n,7n,7n,7n,7n,5n,5n,5n,5n,7n,9n,9n,7n,5n,5n,5n,5n,7n,9n,9n,7n,5n,5n,5n,5n,7n,7n,7n,7n,5n,5n,5n,5n,5n,5n,5n,5n,5n,5n,6n,5n,5n,5n,5n,5n,5n,6n],this.rookMasks=Array(64),this.rookAttacks=Array.from(Array(64),(()=>new Array(4096))),this.rookRelevantBits=[12n,11n,11n,11n,11n,11n,11n,12n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,12n,11n,11n,11n,11n,11n,11n,12n],this.asciiEncodePieces={P:o.P,N:o.N,B:o.B,R:o.R,Q:o.Q,K:o.K,p:o.p,n:o.n,b:o.b,r:o.r,q:o.q,k:o.k},this.promotedPieces={[o.Q]:"q",[o.R]:"r",[o.B]:"b",[o.N]:"n",[o.q]:"q",[o.r]:"r",[o.b]:"b",[o.n]:"n"},this.rookMagicNumbers=[0x8a80104000800020n,0x140002000100040n,0x2801880a0017001n,0x100081001000420n,0x200020010080420n,0x3001c0002010008n,0x8480008002000100n,0x2080088004402900n,0x800098204000n,0x2024401000200040n,0x100802000801000n,0x120800800801000n,0x208808088000400n,0x2802200800400n,0x2200800100020080n,0x801000060821100n,0x80044006422000n,0x100808020004000n,0x12108a0010204200n,0x140848010000802n,0x481828014002800n,0x8094004002004100n,0x4010040010010802n,0x20008806104n,0x100400080208000n,0x2040002120081000n,0x21200680100081n,0x20100080080080n,0x2000a00200410n,0x20080800400n,0x80088400100102n,0x80004600042881n,0x4040008040800020n,0x440003000200801n,0x4200011004500n,0x188020010100100n,0x14800401802800n,0x2080040080800200n,0x124080204001001n,0x200046502000484n,0x480400080088020n,0x1000422010034000n,0x30200100110040n,0x100021010009n,0x2002080100110004n,0x202008004008002n,0x20020004010100n,0x2048440040820001n,0x101002200408200n,0x40802000401080n,0x4008142004410100n,0x2060820c0120200n,0x1001004080100n,0x20c020080040080n,0x2935610830022400n,0x44440041009200n,0x280001040802101n,0x2100190040002085n,0x80c0084100102001n,0x4024081001000421n,0x20030a0244872n,0x12001008414402n,0x2006104900a0804n,0x1004081002402n],this.bishopMagicNumbers=[0x40040844404084n,0x2004208a004208n,0x10190041080202n,0x108060845042010n,0x581104180800210n,0x2112080446200010n,0x1080820820060210n,0x3c0808410220200n,0x4050404440404n,0x21001420088n,0x24d0080801082102n,0x1020a0a020400n,0x40308200402n,0x4011002100800n,0x401484104104005n,0x801010402020200n,0x400210c3880100n,0x404022024108200n,0x810018200204102n,0x4002801a02003n,0x85040820080400n,0x810102c808880400n,0xe900410884800n,0x8002020480840102n,0x220200865090201n,0x2010100a02021202n,0x152048408022401n,0x20080002081110n,0x4001001021004000n,0x800040400a011002n,0xe4004081011002n,0x1c004001012080n,0x8004200962a00220n,0x8422100208500202n,0x2000402200300c08n,0x8646020080080080n,0x80020a0200100808n,0x2010004880111000n,0x623000a080011400n,0x42008c0340209202n,0x209188240001000n,0x400408a884001800n,0x110400a6080400n,0x1840060a44020800n,0x90080104000041n,0x201011000808101n,0x1a2208080504f080n,0x8012020600211212n,0x500861011240000n,0x180806108200800n,0x4000020e01040044n,0x300000261044000an,0x802241102020002n,0x20906061210001n,0x5a84841004010310n,0x4010801011c04n,0xa010109502200n,0x4a02012000n,0x500201010098b028n,0x8040002811040900n,0x28000010020204n,0x6000020202d0240n,0x8918844842082200n,0x4010011029020020n],this.pieceValue=[[82,337,365,477,1025,12e3,-82,-337,-365,-477,-1025,-12e3],[94,281,297,512,936,12e3,-94,-281,-297,-512,-936,-12e3]],this.pieceSquareValues=[[[0,0,0,0,0,0,0,0,98,134,61,95,68,126,34,-11,-6,7,26,31,65,56,25,-20,-14,13,6,21,23,12,17,-23,-27,-2,-5,12,17,6,10,-25,-26,-4,-4,-10,3,3,33,-12,-35,-1,-20,-23,-15,24,38,-22,0,0,0,0,0,0,0,0],[-167,-89,-34,-49,61,-97,-15,-107,-73,-41,72,36,23,62,7,-17,-47,60,37,65,84,129,73,44,-9,17,19,53,37,69,18,22,-13,4,16,13,28,19,21,-8,-23,-9,12,10,19,17,25,-16,-29,-53,-12,-3,-1,18,-14,-19,-105,-21,-58,-33,-17,-28,-19,-23],[-29,4,-82,-37,-25,-42,7,-8,-26,16,-18,-13,30,59,18,-47,-16,37,43,40,35,50,37,-2,-4,5,19,50,37,37,7,-2,-6,13,13,26,34,12,10,4,0,15,15,15,14,27,18,10,4,15,16,0,7,21,33,1,-33,-3,-14,-21,-13,-12,-39,-21],[32,42,32,51,63,9,31,43,27,32,58,62,80,67,26,44,-5,19,26,36,17,45,61,16,-24,-11,7,26,24,35,-8,-20,-36,-26,-12,-1,9,-7,6,-23,-45,-25,-16,-17,3,0,-5,-33,-44,-16,-20,-9,-1,11,-6,-71,-19,-13,1,17,16,7,-37,-26],[-28,0,29,12,59,44,43,45,-24,-39,-5,1,-16,57,28,54,-13,-17,7,8,29,56,47,57,-27,-27,-16,-16,-1,17,-2,1,-9,-26,-9,-10,-2,-4,3,-3,-14,2,-11,-2,-5,2,14,5,-35,-8,11,2,8,15,-3,1,-1,-18,-9,10,-15,-25,-31,-50],[-65,23,16,-15,-56,-34,2,13,29,-1,-20,-7,-8,-4,-38,-29,-9,24,2,-16,-20,6,22,-22,-17,-20,-12,-27,-30,-25,-14,-36,-49,-1,-27,-39,-46,-44,-33,-51,-14,-14,-22,-46,-44,-30,-15,-27,1,7,-8,-64,-43,-16,9,8,-15,36,12,-54,8,-28,24,14]],[[0,0,0,0,0,0,0,0,178,173,158,134,147,132,165,187,94,100,85,67,56,53,82,84,32,24,13,5,-2,4,17,17,13,9,-3,-7,-7,-8,3,-1,4,7,-6,1,0,-5,-1,-8,13,8,8,10,13,0,2,-7,0,0,0,0,0,0,0,0],[-58,-38,-13,-28,-31,-27,-63,-99,-25,-8,-25,-2,-9,-25,-24,-52,-24,-20,10,9,-1,-9,-19,-41,-17,3,22,22,22,11,8,-18,-18,-6,16,25,16,17,4,-18,-23,-3,-1,15,10,-3,-20,-22,-42,-20,-10,-5,-2,-20,-23,-44,-29,-51,-23,-15,-22,-18,-50,-64],[-14,-21,-11,-8,-7,-9,-17,-24,-8,-4,7,-12,-3,-13,-4,-14,2,-8,0,-1,-2,6,0,4,-3,9,12,9,14,10,3,2,-6,3,13,19,7,10,-3,-9,-12,-3,8,10,13,3,-7,-15,-14,-18,-7,-1,4,-9,-15,-27,-23,-9,-23,-5,-9,-16,-5,-17],[13,10,18,15,12,12,8,5,11,13,13,11,-3,3,8,3,7,7,7,5,4,-3,-5,-3,4,3,13,1,2,1,-1,2,3,5,8,4,-5,-6,-8,-11,-4,0,-5,-1,-7,-12,-8,-16,-6,-6,0,2,-9,-9,-11,-3,-9,2,3,-1,-5,-13,4,-20],[-9,22,22,27,27,19,10,20,-17,20,32,41,58,25,30,0,-20,6,9,49,47,35,19,9,3,22,24,45,57,40,57,36,-18,28,19,47,31,34,39,23,-16,-27,15,6,9,17,10,5,-22,-23,-30,-16,-16,-23,-36,-32,-33,-28,-22,-43,-5,-32,-20,-41],[-74,-35,-18,-18,-11,15,4,-17,-12,17,14,17,17,38,23,11,10,17,23,15,20,45,44,13,-8,22,24,27,26,33,26,3,-18,-4,21,24,27,23,9,-11,-19,-3,11,21,23,16,7,-9,-27,-11,4,13,14,4,-5,-17,-53,-34,-21,-11,-28,-14,-24,-43]]],this.hashKey=0n,this.pieceKeys=Array.from(Array(12),(()=>new Array(64))),this.enpassantKeys=[],this.castleKeys=[],this.sideKey=0n,this.hashSize=0,this.hashExact=0,this.hashAlpha=1,this.hashBeta=2,this.hashNoMove=0,this.hashTable={key:new BigUint64Array(this.hashSize),depth:new Uint8Array(this.hashSize),flag:new Uint8Array(this.hashSize),score:new Int32Array(this.hashSize),move:new Uint32Array(this.hashSize)},this.INFINITY=5e4,this.MATE_SCORE=49e3,this.maxPly=64,this.IS_MATE=this.MATE_SCORE-2*this.maxPly,this.ply=0,this.killerMoves=Array(2).fill(0).map((()=>Array(this.maxPly).fill(0))),this.historyMoves=Array(64).fill(0).map((()=>Array(64).fill(0))),this.pvLength=[],this.pvTable=Array(this.maxPly).fill(0).map((()=>Array(this.maxPly).fill(0))),this.followPv=!1,this.scorePv=!1,this.fileMasks=Array(64).fill(0n),this.rankMasks=Array(64).fill(0n),this.isolatedMasks=Array(64).fill(0n),this.wPassedMasks=Array(64).fill(0n),this.bPassedMasks=Array(64).fill(0n),this.doubledPenalty=15,this.isolatedPenalty=7,this.passedBonus=[0,2,4,10,15,25,50,200],this.fileSemiOpenScore=7,this.fileOpenScore=15,this.timing={startTime:0,moveTime:0},this.shouldStop=!1,this.totalMoves=0,this.InitJumperAttacks(),this.InitSliderAttacks(n.bishop),this.InitSliderAttacks(n.rook),this.InitHashKeys(),this.InitHashTable(),this.InitEvalMasks(),i=i||b.positions.start,this.ParseFEN(i)}SetBit(t,s){return t|1n<<c[s]}RemoveBit(t,s){return t&~(1n<<c[s])}GetBit(t,s){return t&1n<<c[s]}CountBits(t){const s=Number(0xffffffffn&t),i=Number(t>>32n);function e(t){return 16843009*((t=(858993459&(t-=t>>1&1431655765))+(t>>2&858993459))+(t>>4)&252645135)>>24}return e(s)+e(i)}GetLS1B(t){return t?this.CountBits((t&-t)-1n):-1}SetOccupancy(t,s,i){let e=0n;for(let n=0;n<s;n++){const s=this.GetLS1B(i);i=this.RemoveBit(i,s),t&1<<n&&(e|=1n<<c[s])}return BigInt.asUintN(64,e)}PrintBitboard(t){for(let s=0;s<8;s++){let i="";for(let e=0;e<8;e++){const n=8*s+e;e||(i+=8-s+"  "),i+=" "+(this.GetBit(t,n)?"1":"0")}console.log(`${i} \r\n`)}console.log("\r\n    a b c d e f g h"),console.log(`    Bitboard: ${t}`)}PrintBoard(t=!1){for(let s=0;s<8;s++){let i="";for(let e=0;e<8;e++){let n=8*s+e,h=-1;e||(i+=8-s+" ");for(let t=o.P;t<=o.k;t++)this.GetBit(this.bitboards[t],n)&&(h=t);i+=t?-1===h?" . ":` ${this.unicodePieces[h]}`:-1===h?" . ":` ${this.asciiPieces[h]} `}console.log(`${i} \r\n`)}console.log("\r\n   a  b  c  d  e  f  g  h"),console.log("Side to move: "+(0===this.side?"white":"black")),console.log(`En passant: ${this.enpassant!==s.no_sq?a[this.enpassant]:"no"}`),console.log(`Castling rights: ${this.castle&h.wk?"K":"-"}${this.castle&h.wq?"Q":"-"}${this.castle&h.bk?"k":"-"}${this.castle&h.bq?"q":"-"}`),console.log(`Hash key: ${this.hashKey.toString(16)}`),console.log("\r\n")}PrintAttackedSquares(t){for(let s=0;s<8;s++){let i="";for(let e=0;e<8;e++){const n=8*s+e;e||(i+=8-s+"  "),i+=` ${this.IsSquareAttacked(n,t)} `}console.log(`${i} \r\n`)}console.log("\r\n    a  b  c  d  e  f  g  h")}PrintMove(t){console.log(`${a[this.GetMoveSource(t)]}${a[this.GetMoveTarget(t)]}${this.GetMovePromoted(t)?this.promotedPieces[this.GetMovePromoted(t)]:""}`)}PrintMoveList(t){if(0===t.length)return void console.log("No moves in move list.");const s=[];for(let i=0;i<t.length;i++){const e=t[i];s.push({Move:`${a[this.GetMoveSource(e)]}${a[this.GetMoveTarget(e)]}${this.GetMovePromoted(e)?this.promotedPieces[this.GetMovePromoted(e)]:" "}`,Piece:`${this.unicodePieces[this.GetMovePiece(e)]}`,Capture:""+(this.GetMoveCapture(e)?1:0),Double:""+(this.GetMoveDouble(e)?1:0),EnPassant:""+(this.GetMoveEnPassant(e)?1:0),Castle:""+(this.GetMoveCastling(e)?1:0)})}console.table(s),console.log(`Total number of moves: ${t.length}`)}PrintMoveScores(t){const s=[];for(let i=0;i<t.length;i++)s.push({move:`${a[this.GetMoveSource(t[i])]}${a[this.GetMoveTarget(t[i])]}${this.GetMovePromoted(t[i])?this.promotedPieces[this.GetMovePromoted(t[i])]:" "}`,score:this.ScoreMove(t[i])});console.table(s)}ParseFEN(t){this.bitboards=[0n,0n,0n,0n,0n,0n,0n,0n,0n,0n,0n,0n],this.occupancies=[0n,0n,0n],this.side=0,this.enpassant=s.no_sq,this.castle=0;let i=t.split(" ")[0].split("/");for(let t=0;t<8;t++){let s=i[t],e=0;for(const i of s){let s=8*t+e;if(i.toLocaleLowerCase()>="a"&&i.toLocaleLowerCase()<="z"){let t=this.asciiEncodePieces[i];this.bitboards[t]=this.SetBit(this.bitboards[t],s),e++}else i>="1"&&i<="8"?e+=parseInt(i,10):console.error(`Invalid FEN character: ${i}`)}}this.side="w"===t.split(" ")[1]?e.White:e.Black;const n=t.split(" ")[2].split("");for(const t of n)switch(t){case"K":this.castle|=h.wk;break;case"Q":this.castle|=h.wq;break;case"k":this.castle|=h.bk;break;case"q":this.castle|=h.bq}const a=t.split(" ")[3];if("-"!==a){const t="abcdefgh".indexOf(a.split("")[0]),s=8-parseInt(a[1],10);this.enpassant=8*s+t}else this.enpassant=s.no_sq;for(let t=o.P;t<=o.K;t++)this.occupancies[e.White]|=this.bitboards[t];for(let t=o.p;t<=o.k;t++)this.occupancies[e.Black]|=this.bitboards[t];this.occupancies[e.Both]|=this.occupancies[e.White]|this.occupancies[e.Black],this.hashKey=this.GenerateHashKeys()}InitHashKeys(){for(let t=o.P;t<=o.k;t++)for(let s=0;s<64;s++)this.pieceKeys[t][s]=d();for(let t=0;t<64;t++)this.enpassantKeys[t]=d();for(let t=0;t<16;t++)this.castleKeys[t]=d();this.sideKey=d()}GenerateHashKeys(){let t,i=0n;for(let s=o.P;s<=o.k;s++)for(t=this.bitboards[s];t;){const e=this.GetLS1B(t);i^=this.pieceKeys[s][e],t=this.RemoveBit(t,e)}return this.enpassant!==s.no_sq&&(i^=this.enpassantKeys[this.enpassant]),i^=this.castleKeys[this.castle],this.side===e.Black&&(i^=this.sideKey),i}MaskPawnAttacks(t,s){let i=0n,e=0n;return e=this.SetBit(e,s),t?(e<<7n&this.notHFile&&(i|=e<<7n),e<<9n&this.notAFile&&(i|=e<<9n)):(e>>7n&this.notAFile&&(i|=e>>7n),e>>9n&this.notHFile&&(i|=e>>9n)),BigInt.asUintN(64,i)}MaskKnightAttacks(t){let s=0n,i=0n;return i=this.SetBit(i,t),i>>17n&this.notHFile&&(s|=i>>17n),i>>15n&this.notAFile&&(s|=i>>15n),i>>10n&this.notHGFile&&(s|=i>>10n),i>>6n&this.notABFile&&(s|=i>>6n),i<<17n&this.notAFile&&(s|=i<<17n),i<<15n&this.notHFile&&(s|=i<<15n),i<<10n&this.notABFile&&(s|=i<<10n),i<<6n&this.notHGFile&&(s|=i<<6n),BigInt.asUintN(64,s)}MaskKingAttacks(t){let s=0n,i=0n;return i=this.SetBit(i,t),i>>8n&&(s|=i>>8n),i>>9n&this.notHFile&&(s|=i>>9n),i>>7n&this.notAFile&&(s|=i>>7n),i>>1n&this.notHFile&&(s|=i>>1n),i<<8n&&(s|=i<<8n),i<<9n&this.notAFile&&(s|=i<<9n),i<<7n&this.notHFile&&(s|=i<<7n),i<<1n&this.notAFile&&(s|=i<<1n),BigInt.asUintN(64,s)}MaskBishopAttacks(t){let s=0n;const i=Math.floor(t/8),e=t%8;for(let t=i+1,n=e+1;t<=6&&n<=6;t++,n++)s|=1n<<8n*BigInt(t)+BigInt(n);for(let t=i-1,n=e+1;t>=1&&n<=6;t--,n++)s|=1n<<8n*BigInt(t)+BigInt(n);for(let t=i+1,n=e-1;t<=6&&n>=1;t++,n--)s|=1n<<8n*BigInt(t)+BigInt(n);for(let t=i-1,n=e-1;t>=1&&n>=1;t--,n--)s|=1n<<8n*BigInt(t)+BigInt(n);return BigInt.asUintN(64,s)}GenerateBishopAttacksFly(t,s){let i=0n;const e=Math.floor(t/8),n=t%8;for(let t=e+1,h=n+1;t<=7&&h<=7&&(i|=1n<<8n*BigInt(t)+BigInt(h),!(1n<<8n*BigInt(t)+BigInt(h)&s));t++,h++);for(let t=e-1,h=n+1;t>=0&&h<=7&&(i|=1n<<8n*BigInt(t)+BigInt(h),!(1n<<8n*BigInt(t)+BigInt(h)&s));t--,h++);for(let t=e+1,h=n-1;t<=7&&h>=0&&(i|=1n<<8n*BigInt(t)+BigInt(h),!(1n<<8n*BigInt(t)+BigInt(h)&s));t++,h--);for(let t=e-1,h=n-1;t>=0&&h>=0&&(i|=1n<<8n*BigInt(t)+BigInt(h),!(1n<<8n*BigInt(t)+BigInt(h)&s));t--,h--);return BigInt.asUintN(64,i)}GetBishopAttacks(t,s){return s=BigInt.asUintN(64,s&this.bishopMasks[t]),s=BigInt.asUintN(64,s*this.bishopMagicNumbers[t]),s>>=64n-this.bishopRelevantBits[t],this.bishopAttacks[t][Number(s)]}MaskRookAttacks(t){let s=0n;const i=Math.floor(t/8),e=t%8;for(let t=i+1;t<=6;t++)s|=1n<<8n*BigInt(t)+BigInt(e);for(let t=i-1;t>=1;t--)s|=1n<<8n*BigInt(t)+BigInt(e);for(let t=e+1;t<=6;t++)s|=1n<<8n*BigInt(i)+BigInt(t);for(let t=e-1;t>=1;t--)s|=1n<<8n*BigInt(i)+BigInt(t);return BigInt.asUintN(64,s)}GenerateRookAttacksFly(t,s){let i=0n;const e=Math.floor(t/8),n=t%8;for(let t=e+1;t<=7&&(i|=1n<<8n*BigInt(t)+BigInt(n),!(1n<<8n*BigInt(t)+BigInt(n)&s));t++);for(let t=e-1;t>=0&&(i|=1n<<8n*BigInt(t)+BigInt(n),!(1n<<8n*BigInt(t)+BigInt(n)&s));t--);for(let t=n+1;t<=7&&(i|=1n<<8n*BigInt(e)+BigInt(t),!(1n<<8n*BigInt(e)+BigInt(t)&s));t++);for(let t=n-1;t>=0&&(i|=1n<<8n*BigInt(e)+BigInt(t),!(1n<<8n*BigInt(e)+BigInt(t)&s));t--);return BigInt.asUintN(64,i)}GetRookAttacks(t,s){return s=BigInt.asUintN(64,s&this.rookMasks[t]),s=BigInt.asUintN(64,s*this.rookMagicNumbers[t]),s>>=64n-this.rookRelevantBits[t],this.rookAttacks[t][Number(s)]}GetQueenAttacks(t,s){return this.GetBishopAttacks(t,s)|this.GetRookAttacks(t,s)}InitSliderAttacks(t){for(let s=0;s<64;s++){this.bishopMasks[s]=this.MaskBishopAttacks(s),this.rookMasks[s]=this.MaskRookAttacks(s);const i=t?this.bishopMasks[s]:this.rookMasks[s],e=this.CountBits(i),n=1<<e;for(let h=0;h<n;h++)if(t){const t=this.SetOccupancy(h,e,i),n=BigInt.asUintN(64,t*this.bishopMagicNumbers[s])>>64n-this.bishopRelevantBits[s];this.bishopAttacks[s][Number(n)]=this.GenerateBishopAttacksFly(s,t)}else{const t=this.SetOccupancy(h,e,i),n=BigInt.asUintN(64,t*this.rookMagicNumbers[s])>>64n-this.rookRelevantBits[s];this.rookAttacks[s][Number(n)]=this.GenerateRookAttacksFly(s,t)}}}InitJumperAttacks(){for(let t=0;t<64;t++)this.pawnAttacks[e.White][t]=this.MaskPawnAttacks(e.White,t),this.pawnAttacks[e.Black][t]=this.MaskPawnAttacks(e.Black,t),this.knightAttacks[t]=this.MaskKnightAttacks(t),this.kingAttacks[t]=this.MaskKingAttacks(t)}IsSquareAttacked(t,s){let i,n,h,a,r;return s===e.White?(i=this.bitboards[o.B]|this.bitboards[o.Q],n=this.bitboards[o.R]|this.bitboards[o.Q],h=this.bitboards[o.P],a=this.bitboards[o.N],r=this.bitboards[o.K]):(i=this.bitboards[o.b]|this.bitboards[o.q],n=this.bitboards[o.r]|this.bitboards[o.q],h=this.bitboards[o.p],a=this.bitboards[o.n],r=this.bitboards[o.k]),this.pawnAttacks[1^s][t]&h||this.knightAttacks[t]&a||this.GetBishopAttacks(t,this.occupancies[e.Both])&i||this.GetRookAttacks(t,this.occupancies[e.Both])&n||this.kingAttacks[t]&r?1:0}FindMagicNumber(t,s,i){const e=new BigUint64Array(4096),n=new BigUint64Array(4096),h=new BigUint64Array(4096),o=i?this.MaskBishopAttacks(t):this.MaskRookAttacks(t),a=1n<<s;for(let s=0;s<a;s++)e[s]=this.SetOccupancy(s,Number(a),o),n[s]=i?this.GenerateBishopAttacksFly(t,e[s]):this.GenerateRookAttacksFly(t,e[s]);for(let t=0;t<1e8;t++){const t=BigInt.asUintN(64,d()&d()&d());if(this.CountBits(o*t&0xff00000000000000n)<6)continue;let i;for(let i=0,o=0;!o&&i<a;i++){const a=Number(BigInt.asIntN(16,e[i]*t>>64n-s));0n===h[a]?h[a]=n[i]:h[a]!==n[i]&&(o=1)}if(!i)return BigInt.asUintN(64,t)}return console.log("Magic number failed!"),0n}InitMagicNumbers(){for(let t=0;t<64;t++){let s=this.FindMagicNumber(t,this.bishopRelevantBits[t],n.bishop).toString(16);s.length%2&&(s="0"+s),console.log(`0x${s}n`)}}GeneratePawnMoves(t,i,n,h){const a=~this.occupancies[e.Both];let r,l=t===e.White?o.P:o.p;const p=(s,i)=>(t===e.White?i<<8n:i>>8n)&s,d=p(n,a),b=((s,i)=>{const n=t===e.White?0x000000ff00000000n:0x00000000ff000000n,h=(t===e.White?(i&n)<<8n:(i&n)>>8n)&i;return p(s,h)})(n,a);for(;n;){const a=this.GetLS1B(n),p=t===e.White?a-8:a+8;for(h||(this.GetBit(n,a)&d&&((t===e.White?p<=s.h8:p>=s.a1)?(this.AddMove(i,this.EncodeMove(a,p,l,t===e.White?o.Q:o.q,0,0,0,0)),this.AddMove(i,this.EncodeMove(a,p,l,t===e.White?o.R:o.r,0,0,0,0)),this.AddMove(i,this.EncodeMove(a,p,l,t===e.White?o.B:o.b,0,0,0,0)),this.AddMove(i,this.EncodeMove(a,p,l,t===e.White?o.N:o.n,0,0,0,0))):this.AddMove(i,this.EncodeMove(a,p,l,0,0,0,0,0))),this.GetBit(n,a)&b&&this.AddMove(i,this.EncodeMove(a,t===e.White?a-16:a+16,l,0,0,1,0,0))),r=this.pawnAttacks[t][a]&this.occupancies[t===e.White?e.Black:e.White];r;){const n=this.GetLS1B(r);(t===e.White?n<=s.h8:n>=s.a1)?(this.AddMove(i,this.EncodeMove(a,n,l,t===e.White?o.Q:o.q,1,0,0,0)),this.AddMove(i,this.EncodeMove(a,n,l,t===e.White?o.R:o.r,1,0,0,0)),this.AddMove(i,this.EncodeMove(a,n,l,t===e.White?o.B:o.b,1,0,0,0)),this.AddMove(i,this.EncodeMove(a,n,l,t===e.White?o.N:o.n,1,0,0,0))):this.AddMove(i,this.EncodeMove(a,n,l,0,1,0,0,0)),r=this.RemoveBit(r,n)}if(this.enpassant!==s.no_sq){const t=this.pawnAttacks[this.side][a]&1n<<c[this.enpassant];if(t){const s=this.GetLS1B(t);this.AddMove(i,this.EncodeMove(a,s,l,0,1,0,1,0))}}n=this.RemoveBit(n,a)}}GenerateMoves(t,i=!1){let n;const a=this.bitboards[o.P],r=this.bitboards[o.p];this.GeneratePawnMoves(this.side,t,this.side===e.White?a:r,i);for(let a=o.P;a<=o.k;a++){if(n=this.bitboards[a],i||(this.side===e.White?a===o.K&&(this.castle&h.wk&&(this.GetBit(this.occupancies[e.Both],s.f1)||this.GetBit(this.occupancies[e.Both],s.g1)||this.IsSquareAttacked(s.e1,e.Black)||this.IsSquareAttacked(s.f1,e.Black)||this.AddMove(t,this.EncodeMove(s.e1,s.g1,a,0,0,0,0,1))),this.castle&h.wq&&(this.GetBit(this.occupancies[e.Both],s.d1)||this.GetBit(this.occupancies[e.Both],s.c1)||this.GetBit(this.occupancies[e.Both],s.b1)||this.IsSquareAttacked(s.e1,e.Black)||this.IsSquareAttacked(s.d1,e.Black)||this.AddMove(t,this.EncodeMove(s.e1,s.c1,a,0,0,0,0,1)))):a===o.k&&(this.castle&h.bk&&(this.GetBit(this.occupancies[e.Both],s.f8)||this.GetBit(this.occupancies[e.Both],s.g8)||this.IsSquareAttacked(s.e8,e.White)||this.IsSquareAttacked(s.f8,e.White)||this.AddMove(t,this.EncodeMove(s.e8,s.g8,a,0,0,0,0,1))),this.castle&h.bq&&(this.GetBit(this.occupancies[e.Both],s.d8)||this.GetBit(this.occupancies[e.Both],s.c8)||this.GetBit(this.occupancies[e.Both],s.b8)||this.IsSquareAttacked(s.e8,e.White)||this.IsSquareAttacked(s.d8,e.White)||this.AddMove(t,this.EncodeMove(s.e8,s.c8,a,0,0,0,0,1))))),this.side===e.White?a===o.N:a===o.n)for(;n;){const s=this.GetLS1B(n);let h=this.knightAttacks[s]&~this.occupancies[this.side];for(;h;){const n=this.GetLS1B(h),o=this.GetBit(this.side===e.White?this.occupancies[e.Black]:this.occupancies[e.White],n);i||o?o&&this.AddMove(t,this.EncodeMove(s,n,a,0,1,0,0,0)):this.AddMove(t,this.EncodeMove(s,n,a,0,0,0,0,0)),h=this.RemoveBit(h,n)}n=this.RemoveBit(n,s)}if(this.side===e.White?a===o.B:a===o.b)for(;n;){const s=this.GetLS1B(n);let h=this.GetBishopAttacks(s,this.occupancies[e.Both])&~this.occupancies[this.side];for(;h;){const n=this.GetLS1B(h),o=this.GetBit(this.side===e.White?this.occupancies[e.Black]:this.occupancies[e.White],n);i||o?o&&this.AddMove(t,this.EncodeMove(s,n,a,0,1,0,0,0)):this.AddMove(t,this.EncodeMove(s,n,a,0,0,0,0,0)),h=this.RemoveBit(h,n)}n=this.RemoveBit(n,s)}if(this.side===e.White?a===o.R:a===o.r)for(;n;){const s=this.GetLS1B(n);let h=this.GetRookAttacks(s,this.occupancies[e.Both])&~this.occupancies[this.side];for(;h;){const n=this.GetLS1B(h),o=this.GetBit(this.side===e.White?this.occupancies[e.Black]:this.occupancies[e.White],n);i||o?o&&this.AddMove(t,this.EncodeMove(s,n,a,0,1,0,0,0)):this.AddMove(t,this.EncodeMove(s,n,a,0,0,0,0,0)),h=this.RemoveBit(h,n)}n=this.RemoveBit(n,s)}if(this.side===e.White?a===o.Q:a===o.q)for(;n;){const s=this.GetLS1B(n);let h=this.GetQueenAttacks(s,this.occupancies[e.Both])&~this.occupancies[this.side];for(;h;){const n=this.GetLS1B(h),o=this.GetBit(this.side===e.White?this.occupancies[e.Black]:this.occupancies[e.White],n);i||o?o&&this.AddMove(t,this.EncodeMove(s,n,a,0,1,0,0,0)):this.AddMove(t,this.EncodeMove(s,n,a,0,0,0,0,0)),h=this.RemoveBit(h,n)}n=this.RemoveBit(n,s)}if(this.side===e.White?a===o.K:a===o.k)for(;n;){const s=this.GetLS1B(n);let h=this.kingAttacks[s]&~this.occupancies[this.side];for(;h;){const n=this.GetLS1B(h),o=this.GetBit(this.side===e.White?this.occupancies[e.Black]:this.occupancies[e.White],n);i||o?o&&this.AddMove(t,this.EncodeMove(s,n,a,0,1,0,0,0)):this.AddMove(t,this.EncodeMove(s,n,a,0,0,0,0,0)),h=this.RemoveBit(h,n)}n=this.RemoveBit(n,s)}}}EncodeMove(t,s,i,e,n,h,o,a){return t|s<<6|i<<12|e<<16|n<<20|h<<21|o<<22|a<<23}GetMoveSource(t){return 63&t}GetMoveTarget(t){return(4032&t)>>6}GetMovePiece(t){return(61440&t)>>12}GetMovePromoted(t){return(983040&t)>>16}GetMoveCapture(t){return 1048576&t}GetMoveDouble(t){return 2097152&t}GetMoveEnPassant(t){return 4194304&t}GetMoveCastling(t){return 8388608&t}AddMove(t,s){t.push(s)}TakeBack(){const t=this.moveStack.pop();this.bitboards=t.bitboards,this.occupancies=t.occupancies,this.side=t.side,this.enpassant=t.enpassant,this.castle=t.castle,this.hashKey=t.hashKey}MakeMove(t){this.moveStack.push({bitboards:this.bitboards.slice(0),occupancies:this.occupancies.slice(0),side:this.side,enpassant:this.enpassant,castle:this.castle,hashKey:this.hashKey});const i=63&t,n=(4032&t)>>6,h=(61440&t)>>12,a=(983040&t)>>16,c=1048576&t,l=2097152&t,p=4194304&t,d=8388608&t;if(this.bitboards[h]=this.RemoveBit(this.bitboards[h],i),this.bitboards[h]=this.SetBit(this.bitboards[h],n),this.hashKey^=this.pieceKeys[h][i],this.hashKey^=this.pieceKeys[h][n],c){let t,s;this.side===e.White?(t=o.p,s=o.k):(t=o.P,s=o.K);for(let i=t;i<=s;i++)if(this.GetBit(this.bitboards[i],n)){this.bitboards[i]=this.RemoveBit(this.bitboards[i],n),this.hashKey^=this.pieceKeys[i][n];break}}if(a&&(this.side===e.White?(this.bitboards[h]=this.RemoveBit(this.bitboards[o.P],n),this.hashKey^=this.pieceKeys[o.P][n]):(this.bitboards[h]=this.RemoveBit(this.bitboards[o.p],n),this.hashKey^=this.pieceKeys[o.p][n]),this.bitboards[a]=this.SetBit(this.bitboards[a],n),this.hashKey^=this.pieceKeys[a][n]),p&&(this.side===e.White?(this.bitboards[o.p]=this.RemoveBit(this.bitboards[o.p],n+8),this.hashKey^=this.pieceKeys[o.p][n+8]):(this.bitboards[o.P]=this.RemoveBit(this.bitboards[o.P],n-8),this.hashKey^=this.pieceKeys[o.P][n-8])),this.enpassant!==s.no_sq&&(this.hashKey^=this.enpassantKeys[this.enpassant]),this.enpassant=s.no_sq,l){const t=n+8*(-1)**this.side;this.enpassant=t,this.hashKey^=this.enpassantKeys[t]}if(d)switch(n){case s.g1:this.bitboards[o.R]=this.RemoveBit(this.bitboards[o.R],s.h1),this.bitboards[o.R]=this.SetBit(this.bitboards[o.R],s.f1),this.hashKey^=this.pieceKeys[o.R][s.h1],this.hashKey^=this.pieceKeys[o.R][s.f1];break;case s.c1:this.bitboards[o.R]=this.RemoveBit(this.bitboards[o.R],s.a1),this.bitboards[o.R]=this.SetBit(this.bitboards[o.R],s.d1),this.hashKey^=this.pieceKeys[o.R][s.a1],this.hashKey^=this.pieceKeys[o.R][s.d1];break;case s.g8:this.bitboards[o.r]=this.RemoveBit(this.bitboards[o.r],s.h8),this.bitboards[o.r]=this.SetBit(this.bitboards[o.r],s.f8),this.hashKey^=this.pieceKeys[o.r][s.h8],this.hashKey^=this.pieceKeys[o.r][s.f8];break;case s.c8:this.bitboards[o.r]=this.RemoveBit(this.bitboards[o.r],s.a8),this.bitboards[o.r]=this.SetBit(this.bitboards[o.r],s.d8),this.hashKey^=this.pieceKeys[o.r][s.a8],this.hashKey^=this.pieceKeys[o.r][s.d8]}return this.hashKey^=this.castleKeys[this.castle],this.castle&=r[i]&r[n],this.hashKey^=this.castleKeys[this.castle],this.occupancies=[0n,0n,0n],this.occupancies[e.White]=this.bitboards[o.P]|this.bitboards[o.N]|this.bitboards[o.B]|this.bitboards[o.R]|this.bitboards[o.Q]|this.bitboards[o.K],this.occupancies[e.Black]=this.bitboards[o.p]|this.bitboards[o.n]|this.bitboards[o.b]|this.bitboards[o.r]|this.bitboards[o.q]|this.bitboards[o.k],this.occupancies[e.Both]=this.occupancies[e.White]|this.occupancies[e.Black],this.side^=1,this.hashKey^=this.sideKey,this.IsSquareAttacked(this.side===e.White?this.GetLS1B(this.bitboards[o.k]):this.GetLS1B(this.bitboards[o.K]),this.side)?(this.TakeBack(),0):1}InitHashTable(t=16*this.hashSize/1048576||32){t>512||t<1?(this.hashSize=2097152,console.log(`Unable to set hash table size to ${t}. Setting to default of 32MB`)):(this.hashSize=1048576*t/16,console.log(`Hash table size set to: ${t}MB`)),this.hashTable={key:new BigUint64Array(this.hashSize),depth:new Uint8Array(this.hashSize),flag:new Uint8Array(this.hashSize),score:new Int32Array(this.hashSize),move:new Uint32Array(this.hashSize)}}WriteHash(t,s,i,e){const n=Number(this.hashKey%BigInt(this.hashSize));if(i>this.MATE_SCORE&&(i+=this.ply),i<-this.MATE_SCORE&&(i-=this.ply),this.hashTable.key[n]=this.hashKey,this.hashTable.key[n]<0n||0n===this.hashTable.key[n])throw new Error(`Bad hash key: ${this.hashTable.key[n]} (${this.hashKey})`);this.hashTable.score[n]=i,this.hashTable.flag[n]=s,this.hashTable.depth[n]=t,this.hashTable.move[n]=e}ProbeHash(){const t=Number(this.hashKey%BigInt(this.hashSize)),s={key:this.hashTable.key[t],depth:this.hashTable.depth[t],flag:this.hashTable.flag[t],score:this.hashTable.score[t],move:this.hashTable.move[t]};return s.key===this.hashKey?s:this.hashNoMove}SetFileRankMask(t,s){let i=0n;for(let e=0;e<8;e++)for(let n=0;n<8;n++){const h=8*e+n;-1!==t&&n===t&&(i|=this.SetBit(i,h)),-1!==s&&e===s&&(i|=this.SetBit(i,h))}return i}InitEvalMasks(){for(let t=0;t<8;t++)for(let s=0;s<8;s++){const i=8*t+s;this.fileMasks[i]|=this.SetFileRankMask(s,-1),this.rankMasks[i]|=this.SetFileRankMask(-1,t),this.isolatedMasks[i]|=this.SetFileRankMask(s-1,-1)|this.SetFileRankMask(s+1,-1),this.wPassedMasks[i]|=this.SetFileRankMask(s-1,-1)|this.SetFileRankMask(s,-1)|this.SetFileRankMask(s+1,-1),this.bPassedMasks[i]|=this.SetFileRankMask(s-1,-1)|this.SetFileRankMask(s,-1)|this.SetFileRankMask(s+1,-1);for(let e=0;e<8-t;e++)this.wPassedMasks[i]&=~this.rankMasks[8*(7-e)+s];for(let e=0;e<t+1;e++)this.bPassedMasks[i]&=~this.rankMasks[8*e+s]}}CheckTime(){const t=Date.now()-this.timing.startTime;this.timing.moveTime&&t>=this.timing.moveTime&&(this.shouldStop=!0)}Evaluate(){let s=0,i=0,e=24;for(let n=o.P;n<=o.k;n++){let h=this.bitboards[n];if(h)for(;h;){let a=this.GetLS1B(h);if(n<=5?(s+=this.pieceSquareValues[t.Opening][n][a],i+=this.pieceSquareValues[t.Endgame][n][a],s+=this.pieceValue[t.Opening][n],i+=this.pieceValue[t.Endgame][n]):(s-=this.pieceSquareValues[t.Opening][n-6][56^a],i-=this.pieceSquareValues[t.Endgame][n-6][56^a],s+=this.pieceValue[t.Opening][n],i+=this.pieceValue[t.Endgame][n]),n!==o.Q&&n!==o.q||(e-=4),n!==o.N&&n!==o.n||(e-=1),n!==o.B&&n!==o.b||(e-=1),n===o.P&&(0n!==this.GetBit(this.bitboards[o.P],a+8)&&(s-=this.doubledPenalty,i-=this.doubledPenalty),0n===(this.bitboards[o.P]&this.isolatedMasks[a])&&(s-=this.isolatedPenalty,i-=this.isolatedPenalty),0n===(this.wPassedMasks[a]&this.bitboards[o.p]))){const t=7-(a>>3);s+=this.passedBonus[t],i+=this.passedBonus[t]}if(n===o.p&&(0n!==this.GetBit(this.bitboards[o.p],a-8)&&(s+=this.doubledPenalty,i+=this.doubledPenalty),0n===(this.bitboards[o.p]&this.isolatedMasks[56^a])&&(s+=this.isolatedPenalty,i+=this.isolatedPenalty),0n===(this.bPassedMasks[a]&this.bitboards[o.P]))){const t=7-((56^a)>>3);s-=this.passedBonus[t],i-=this.passedBonus[t]}n===o.R&&(0n===(this.bitboards[o.P]&this.fileMasks[a])&&(s+=this.fileSemiOpenScore,i+=this.fileSemiOpenScore),0n===((this.bitboards[o.P]|this.bitboards[o.p])&this.fileMasks[a])&&(s+=this.fileOpenScore,i+=this.fileOpenScore),e-=2),n===o.r&&(0n===(this.bitboards[o.p]&this.fileMasks[56^a])&&(s-=this.fileSemiOpenScore,i-=this.fileSemiOpenScore),0n===((this.bitboards[o.P]|this.bitboards[o.p])&this.fileMasks[56^a])&&(s-=this.fileOpenScore,i-=this.fileOpenScore),e-=2),h=this.RemoveBit(h,a)}}return e=(256*e+12)/24|0,((s*(256-e)+i*e)/256|0)*(-1)**this.side}Search(t){this.followPv=!1,this.scorePv=!1,this.nodesCount=0,this.killerMoves=Array(2).fill(0).map((()=>Array(this.maxPly).fill(0))),this.historyMoves=Array(64).fill(0).map((()=>Array(64).fill(0))),this.pvLength=[],this.pvTable=Array(this.maxPly).fill(0).map((()=>Array(this.maxPly).fill(0))),this.timing.startTime=Date.now();let s=-this.INFINITY,i=this.INFINITY,e=-this.INFINITY,n=-this.INFINITY;for(let h=1;!this.shouldStop&&h<=t;h++){for(this.followPv=!0,h>=4&&(n=50,s=Math.max(e-n,-this.INFINITY),i=Math.min(e+n,this.INFINITY));e=this.Negamax(s,i,h,!0),!this.shouldStop;){if(e<=s)i=(s+i)/2,s=Math.max(e-n,-this.INFINITY);else{if(!(e>=i))break;i=Math.min(e+n,this.INFINITY)}n+=Math.floor(n/4)+5}if(this.shouldStop)break;const t=()=>e<-this.IS_MATE?"mate "+(-this.MATE_SCORE-e)/2:e>this.IS_MATE?"mate "+(this.MATE_SCORE-e+1)/2:`cp ${e}`,o=()=>{let t="";for(let s=0;s<this.pvLength[0];s++)t+=`${a[this.GetMoveSource(this.pvTable[0][s])]}${a[this.GetMoveTarget(this.pvTable[0][s])]}${this.GetMovePromoted(this.pvTable[0][s])?this.promotedPieces[this.GetMovePromoted(this.pvTable[0][s])]:""}`,t+=" ";return t};if(console.log(`info score ${t()} depth ${h} nodes ${this.nodesCount} time ${Date.now()-this.timing.startTime} pv ${o()}`),e>this.IS_MATE||e<-this.IS_MATE)break}return console.log(`bestmove ${a[this.GetMoveSource(this.pvTable[0][0])]}${a[this.GetMoveTarget(this.pvTable[0][0])]}${this.GetMovePromoted(this.pvTable[0][0])?this.promotedPieces[this.GetMovePromoted(this.pvTable[0][0])]:""}`),`${a[this.GetMoveSource(this.pvTable[0][0])]}${a[this.GetMoveTarget(this.pvTable[0][0])]}${this.GetMovePromoted(this.pvTable[0][0])?this.promotedPieces[this.GetMovePromoted(this.pvTable[0][0])]:""}`}Negamax(i,n,h,a){let r=0,c=0,l=-this.INFINITY,p=this.hashAlpha,d=0;const b=n>1+i;if(this.pvLength[this.ply]=this.ply,this.nodesCount++,this.CheckTime(),this.shouldStop)return 0;const k=this.ProbeHash();if(d="number"!=typeof k?k.move:this.hashNoMove,this.ply&&!b&&"number"!=typeof k){let t=k.score;if(k.depth>=h&&(t>this.MATE_SCORE&&(t-=this.ply),t<-this.MATE_SCORE&&(t+=this.ply),k.flag===this.hashExact||(k.flag===this.hashBeta?k.score>=n:k.score<=i)))return t}if(this.ply&&this.IsRepetition())return 0;if(0===h)return this.Quiescence(i,n,0);if(this.ply>=this.maxPly)return this.Evaluate();const f=this.MATE_SCORE-this.ply;if(f<n&&(n=f,i>=f))return f;if(-f>i&&(i=-f,n<=-f))return-f;const u=this.IsSquareAttacked(this.side===e.White?this.GetLS1B(this.bitboards[o.K]):this.GetLS1B(this.bitboards[o.k]),1^this.side);if(u&&h++,a&&!u&&!b){const e=this.Evaluate();if(this.ply&&h>2&&e>=n&&(this.moveStack.push({bitboards:this.bitboards.slice(0),occupancies:this.occupancies.slice(0),side:this.side,enpassant:this.enpassant,castle:this.castle,hashKey:this.hashKey}),this.enpassant!==s.no_sq&&(this.hashKey^=this.enpassantKeys[this.enpassant]),this.side^=1,this.enpassant=s.no_sq,this.hashKey^=this.sideKey,this.ply++,l=-this.Negamax(-n,1-n,h-3,!1),this.ply--,this.TakeBack(),l>=n))return n;if(h<2){let s=e+this.pieceValue[t.Opening][o.P];if(s<n){if(1===h){let t=this.Quiescence(i,n,h);return Math.max(t,s)}if(s+=2*this.pieceValue[t.Opening][o.P],s<n&&h<=3){let t=this.Quiescence(i,n,h);if(t<n)return Math.max(t,s)}}}}let v=[];this.GenerateMoves(v),this.followPv&&this.EnabledPVScoring(v),v=this.SortMoves(v,d);for(let t=0;t<v.length;t++){this.ply++;const s=v[t];if(this.MakeMove(s)){if(c++,h>=3&&r>=4&&!u&&!this.GetMoveCapture(s)&&!this.GetMovePromoted(s)){const t=r<=6?1:Math.floor(h/3);l=-this.Negamax(-i-1,-i,h-1-t,!0),l>i&&(l=-this.Negamax(-n,-i,h-1,!0))}else l=-this.Negamax(-n,-i,h-1,!0);if(this.ply--,this.TakeBack(),this.shouldStop)return 0;if(r++,l>i){p=this.hashExact,d=s,this.GetMoveCapture(s)||(this.historyMoves[this.GetMoveSource(s)][this.GetMoveTarget(s)]+=h*h),i=l,this.pvTable[this.ply][this.ply]=s;for(let t=this.ply+1;t<this.pvLength[this.ply+1];t++)this.pvTable[this.ply][t]=this.pvTable[this.ply+1][t];this.pvLength[this.ply]=this.pvLength[this.ply+1]}if(l>=n)return this.WriteHash(h,this.hashBeta,l,s),this.GetMoveCapture(s)||(this.killerMoves[1][this.ply]=this.killerMoves[0][this.ply],this.killerMoves[0][this.ply]=s),n}else this.ply--}return c?(this.WriteHash(h,p,l,d),i):u?-this.MATE_SCORE+this.ply:0}Quiescence(t,s,i){this.nodesCount++;const e=this.ProbeHash();if(this.ply&&"number"!=typeof e){let n=e.score;if(e.depth>=i&&(n>this.MATE_SCORE&&(n-=this.ply),n<-this.MATE_SCORE&&(n+=this.ply),e.flag===this.hashExact||(e.flag===this.hashBeta?e.score>=s:e.score<=t)))return n}if(this.ply>=this.maxPly)return this.Evaluate();const n=this.Evaluate();if(n>=s)return s;if(n<t-900)return t;t<n&&(t=n);let h=[];this.GenerateMoves(h,!0),h=this.SortMoves(h);for(let e=0;e<h.length;e++){if(this.ply++,!this.MakeMove(h[e])){this.ply--;continue}let n=-this.Quiescence(-s,-t,i);if(this.ply--,this.TakeBack(),this.shouldStop)return 0;if(n>t&&(t=n,n>=s))return s}return t}IsRepetition(){let t=0;for(let s=4;s<=this.moveStack.length;s+=2)this.moveStack[this.moveStack.length-s].hashKey===this.hashKey&&t++;return t>=2}EnabledPVScoring(t){this.followPv=!1;for(let s=0;s<t.length;s++)this.pvTable[0][this.ply]===t[s]&&(this.scorePv=!0,this.followPv=!0)}ScoreMove(t){if(this.scorePv&&this.pvTable[0][this.ply]===t)return this.scorePv=!1,this.INFINITY;if(this.GetMoveCapture(t)){let s,i,n=o.P;this.side===e.White?(s=o.p,i=o.k):(s=o.P,i=o.K);for(let e=s;e<=i;e++)if(this.GetBit(this.bitboards[e],this.GetMoveTarget(t))){n=e;break}return Math.abs(this.pieceValue[this.gamePhase][Math.abs(n)])-(this.GetMovePiece(t)+1)+1e4}return this.killerMoves[0][this.ply]===t?9e3:this.killerMoves[1][this.ply]===t?8e3:this.historyMoves[this.GetMoveSource(t)][this.GetMoveTarget(t)]}SortMoves(t,s=0){const i=t.map(((t,i)=>{let e=0;return e=t===s?3e4:this.ScoreMove(t),{i,value:e}}));return i.sort(((t,s)=>t.value<s.value?1:t.value>s.value?-1:0)),i.map((s=>t[s.i]))}Perft(t){const s=Date.now(),i=[];this.GenerateMoves(i);for(let s=0;s<i.length;s++){const e=i[s];if(!this.MakeMove(e))continue;let n=this.PerftDriver(t-1);console.log(`${a[this.GetMoveSource(e)]}${a[this.GetMoveTarget(e)]}: ${n}`),this.TakeBack()}console.log(`Time taken: ${Date.now()-s} ms`),console.log(`Nodes: ${this.nodesCount.toLocaleString()}`)}PerftDriver(t){let s=0;if(0===t)return this.nodesCount++,1;const i=[];this.GenerateMoves(i);for(let e=0;e<i.length;e++)this.MakeMove(i[e])&&(s+=this.PerftDriver(t-1),this.TakeBack());return s}ParseUCIMove(t){const s=[];this.GenerateMoves(s);for(let i=0;i<s.length;i++)if(a[this.GetMoveSource(s[i])]+a[this.GetMoveTarget(s[i])]+(this.GetMovePromoted(s[i])?this.promotedPieces[this.GetMovePromoted(s[i])]:"")===t)return s[i];return 0}ParseUCIPosition(t){const s=t.split(" ").slice(1).join(" ");s.startsWith("startpos")?this.ParseFEN(b.positions.start):s.startsWith("fen")?this.ParseFEN(s.split(" ").slice(1).join(" ")):this.ParseFEN(b.positions.start);const i=s.split("moves ").slice(1).join(" ").split(" ").filter((t=>""!=t));this.totalMoves=i.length;for(let s=0;s<i.length;s++){const e=this.ParseUCIMove(i[s]);if(!e){console.error("Unable to parse UCI command"),console.log(`Command: ${t}`),console.log(`Invalid move: ${i[s]}`);break}this.MakeMove(e)}this.PrintBoard(!0)}ParseUCIGo(t){this.timing.startTime=0,this.timing.moveTime=0,this.shouldStop=!1;let s=parseInt((t.match(/movetime (\d+)/)||[])[1])||0,i=parseInt((t.match(/depth (\d+)/)||[])[1])||64;if(!s){let i,n,h=parseInt((t.match(/movestogo (\d+)/)||[])[1])||35;this.side===e.White?(n=parseInt((t.match(/winc (\d+)/)||[])[1])||0,i=parseInt((t.match(/wtime (\d+)/)||[])[1])||0):(n=parseInt((t.match(/binc (\d+)/)||[])[1])||0,i=parseInt((t.match(/btime (\d+)/)||[])[1])||0),h=this.totalMoves<=20?45-this.totalMoves:25,s=i/h+n}return(i>64||i<=0)&&(i=64),console.log(`Move time: ${s}`),this.timing.moveTime=s,this.Search(i)}}b.positions={empty:"8/8/8/8/8/8/8/8 b - - ",start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",kiwipete:"r3k2r/p1ppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q1p/PPPBBPPP/R3K2R w KQkq -",pos3:"8/2p5/3p4/KP5r/1R3p1k/8/4P1P1/8 w - -",pos4w:"r3k2r/Pppp1ppp/1b3nbN/nP6/BBP1P3/q4N2/Pp1P2PP/R2Q1RK1 w kq - 0 1",pos4b:"r2q1rk1/pP1p2pp/Q4n2/bbp1p3/Np6/1B3NBn/pPPP1PPP/R3K2R b KQ - 0 1",pos5:"rnbq1k1r/pp1Pbppp/2p5/8/2B5/8/PPP1NnPP/RNBQK2R w KQ - 1 8",pos6:"r4rk1/1pp1qppp/p1np1n2/2b1p1B1/2B1P1b1/P1NP1N2/1PP1QPPP/R4RK1 w - - 0 10"};const k=b,f=i(58);new class{constructor(){this.engine=new k,this.interface=f.createInterface({input:process.stdin,output:process.stdout,terminal:!1}),this.interface.on("line",(t=>{const s=t.split(" ")[0];switch(s){case"uci":console.log(`id name ${this.engine.name} ${this.engine.version}`),console.log(`id author ${this.engine.author}`),console.log("option name Hash type spin default 32 min 1 max 512"),console.log("uciok");break;case"isready":console.log("readyok");break;case"quit":process.exit();break;case"ucinewgame":this.engine=new k;break;case"position":this.engine.ParseUCIPosition(t);break;case"go":this.engine.ParseUCIGo(t);break;case"setoption":{const s=parseInt((t.match(/Hash value (\d+)/)||[])[1])||0;s&&this.engine.InitHashTable(s);break}default:console.log(`Unrecognized command: ${s}`)}}))}}})()})();