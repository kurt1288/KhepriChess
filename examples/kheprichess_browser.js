var Engine;(()=>{"use strict";var s,i={d:(s,t)=>{for(var o in t)i.o(t,o)&&!i.o(s,o)&&Object.defineProperty(s,o,{enumerable:!0,get:t[o]})},o:(s,i)=>Object.prototype.hasOwnProperty.call(s,i)},t={};i.d(t,{default:()=>e}),function(s){s[s.a8=0]="a8",s[s.b8=1]="b8",s[s.c8=2]="c8",s[s.d8=3]="d8",s[s.e8=4]="e8",s[s.f8=5]="f8",s[s.g8=6]="g8",s[s.h8=7]="h8",s[s.a7=8]="a7",s[s.b7=9]="b7",s[s.c7=10]="c7",s[s.d7=11]="d7",s[s.e7=12]="e7",s[s.f7=13]="f7",s[s.g7=14]="g7",s[s.h7=15]="h7",s[s.a6=16]="a6",s[s.b6=17]="b6",s[s.c6=18]="c6",s[s.d6=19]="d6",s[s.e6=20]="e6",s[s.f6=21]="f6",s[s.g6=22]="g6",s[s.h6=23]="h6",s[s.a5=24]="a5",s[s.b5=25]="b5",s[s.c5=26]="c5",s[s.d5=27]="d5",s[s.e5=28]="e5",s[s.f5=29]="f5",s[s.g5=30]="g5",s[s.h5=31]="h5",s[s.a4=32]="a4",s[s.b4=33]="b4",s[s.c4=34]="c4",s[s.d4=35]="d4",s[s.e4=36]="e4",s[s.f4=37]="f4",s[s.g4=38]="g4",s[s.h4=39]="h4",s[s.a3=40]="a3",s[s.b3=41]="b3",s[s.c3=42]="c3",s[s.d3=43]="d3",s[s.e3=44]="e3",s[s.f3=45]="f3",s[s.g3=46]="g3",s[s.h3=47]="h3",s[s.a2=48]="a2",s[s.b2=49]="b2",s[s.c2=50]="c2",s[s.d2=51]="d2",s[s.e2=52]="e2",s[s.f2=53]="f2",s[s.g2=54]="g2",s[s.h2=55]="h2",s[s.a1=56]="a1",s[s.b1=57]="b1",s[s.c1=58]="c1",s[s.d1=59]="d1",s[s.e1=60]="e1",s[s.f1=61]="f1",s[s.g1=62]="g1",s[s.h1=63]="h1",s[s.no_sq=64]="no_sq"}(s||(s={}));class o{constructor(){this.name="KhepriChess",this.version="3.0.0",this.author="Kurt Peters",this.isChess960=!1,this.SquareBigInt=[0n,1n,2n,3n,4n,5n,6n,7n,8n,9n,10n,11n,12n,13n,14n,15n,16n,17n,18n,19n,20n,21n,22n,23n,24n,25n,26n,27n,28n,29n,30n,31n,32n,33n,34n,35n,36n,37n,38n,39n,40n,41n,42n,43n,44n,45n,46n,47n,48n,49n,50n,51n,52n,53n,54n,55n,56n,57n,58n,59n,60n,61n,62n,63n,64n],this.Position={PiecesBB:[],OccupanciesBB:[0n,0n],Squares:[],CastlingRights:0,SideToMove:0,EnPassSq:0,HalfMoves:0,Ply:0,Hash:0n,PawnHash:0n,Phase:0,CastlingPaths:[],CastlingRookSquares:[],CastlingSquaresMask:[]},this.PositionHistory=[],this.CharToPiece=new Map([["P",{Type:0,Color:0}],["N",{Type:1,Color:0}],["B",{Type:2,Color:0}],["R",{Type:3,Color:0}],["Q",{Type:4,Color:0}],["K",{Type:5,Color:0}],["p",{Type:0,Color:1}],["n",{Type:1,Color:1}],["b",{Type:2,Color:1}],["r",{Type:3,Color:1}],["q",{Type:4,Color:1}],["k",{Type:5,Color:1}]]),this.stateCopy=[],this.rankMasks=[],this.fileMasks=[],this.isolatedMasks=[],this.passedMasks=Array(2).fill(0).map((()=>Array(64).fill(0))),this.betweenMasks=Array(64).fill(0n).map((()=>Array(64).fill(0n))),this.attackRays=Array.from(Array(3),(()=>new Array(64).fill(0n))),this.squareBB=[],this.distanceBetween=Array(64).fill(0n).map((()=>Array(64).fill(0n))),this.notAFile=18374403900871474942n,this.notHFile=9187201950435737471n,this.notHGFile=4557430888798830399n,this.notABFile=18229723555195321596n,this.PRNG_SEED=1n,this.Zobrist={Pieces:Array.from(Array(2),(()=>Array.from(Array(6),(()=>new Array(64))))),EnPassant:[],Castle:[],SideToMove:0n},this.HashNoMove=5e4,this.TranspositionTables={Entries:[],Size:0n},this.PawnHashTable={Entries:[],Size:0n},this.PawnAttacks=Array.from(Array(2),(()=>new Array(64))),this.KnightAttacks=[],this.KingAttacks=[],this.BishopMasks=Array(64),this.BishopAttacks=Array.from(Array(64),(()=>new Array(512))),this.RookMasks=Array(64),this.RookAttacks=Array.from(Array(64),(()=>new Array(4096))),this.BishopMagicNumbers=[0x40040844404084n,0x2004208a004208n,0x10190041080202n,0x108060845042010n,0x581104180800210n,0x2112080446200010n,0x1080820820060210n,0x3c0808410220200n,0x4050404440404n,0x21001420088n,0x24d0080801082102n,0x1020a0a020400n,0x40308200402n,0x4011002100800n,0x401484104104005n,0x801010402020200n,0x400210c3880100n,0x404022024108200n,0x810018200204102n,0x4002801a02003n,0x85040820080400n,0x810102c808880400n,0xe900410884800n,0x8002020480840102n,0x220200865090201n,0x2010100a02021202n,0x152048408022401n,0x20080002081110n,0x4001001021004000n,0x800040400a011002n,0xe4004081011002n,0x1c004001012080n,0x8004200962a00220n,0x8422100208500202n,0x2000402200300c08n,0x8646020080080080n,0x80020a0200100808n,0x2010004880111000n,0x623000a080011400n,0x42008c0340209202n,0x209188240001000n,0x400408a884001800n,0x110400a6080400n,0x1840060a44020800n,0x90080104000041n,0x201011000808101n,0x1a2208080504f080n,0x8012020600211212n,0x500861011240000n,0x180806108200800n,0x4000020e01040044n,0x300000261044000an,0x802241102020002n,0x20906061210001n,0x5a84841004010310n,0x4010801011c04n,0xa010109502200n,0x4a02012000n,0x500201010098b028n,0x8040002811040900n,0x28000010020204n,0x6000020202d0240n,0x8918844842082200n,0x4010011029020020n],this.RookMagicNumbers=[0x8a80104000800020n,0x140002000100040n,0x2801880a0017001n,0x100081001000420n,0x200020010080420n,0x3001c0002010008n,0x8480008002000100n,0x2080088004402900n,0x800098204000n,0x2024401000200040n,0x100802000801000n,0x120800800801000n,0x208808088000400n,0x2802200800400n,0x2200800100020080n,0x801000060821100n,0x80044006422000n,0x100808020004000n,0x12108a0010204200n,0x140848010000802n,0x481828014002800n,0x8094004002004100n,0x4010040010010802n,0x20008806104n,0x100400080208000n,0x2040002120081000n,0x21200680100081n,0x20100080080080n,0x2000a00200410n,0x20080800400n,0x80088400100102n,0x80004600042881n,0x4040008040800020n,0x440003000200801n,0x4200011004500n,0x188020010100100n,0x14800401802800n,0x2080040080800200n,0x124080204001001n,0x200046502000484n,0x480400080088020n,0x1000422010034000n,0x30200100110040n,0x100021010009n,0x2002080100110004n,0x202008004008002n,0x20020004010100n,0x2048440040820001n,0x101002200408200n,0x40802000401080n,0x4008142004410100n,0x2060820c0120200n,0x1001004080100n,0x20c020080040080n,0x2935610830022400n,0x44440041009200n,0x280001040802101n,0x2100190040002085n,0x80c0084100102001n,0x4024081001000421n,0x20030a0244872n,0x12001008414402n,0x2006104900a0804n,0x1004081002402n],this.BishopRelevantBits=[6n,5n,5n,5n,5n,5n,5n,6n,5n,5n,5n,5n,5n,5n,5n,5n,5n,5n,7n,7n,7n,7n,5n,5n,5n,5n,7n,9n,9n,7n,5n,5n,5n,5n,7n,9n,9n,7n,5n,5n,5n,5n,7n,7n,7n,7n,5n,5n,5n,5n,5n,5n,5n,5n,5n,5n,6n,5n,5n,5n,5n,5n,5n,6n],this.RookRelevantBits=[12n,11n,11n,11n,11n,11n,11n,12n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,11n,10n,10n,10n,10n,10n,10n,11n,12n,11n,11n,11n,11n,11n,11n,12n],this.MGPieceValue=[80,321,328,447,912,15e3],this.EGPieceValue=[102,256,271,472,911,15e3],this.PST=[[[0,0,0,0,0,0,0,0,24,24,16,16,9,10,7,6,0,11,12,8,13,21,10,-6,-23,4,-5,12,16,3,5,-26,-28,-13,-6,3,6,0,0,-30,-24,-13,-9,-10,0,-2,21,-15,-28,-8,-25,-17,-12,11,28,-21,0,0,0,0,0,0,0,0],[-11,-2,-1,-1,1,-4,-1,-5,-9,-4,5,4,2,4,0,-2,-6,9,3,11,14,13,12,5,2,0,-1,18,6,20,9,18,0,-1,-3,-10,3,-3,8,8,-10,-14,-10,-5,6,-2,4,-6,-5,-5,-19,-1,-3,0,-1,4,-5,-2,-6,-5,0,3,-2,-3],[-4,0,-4,-2,-1,-1,-1,-1,-8,-3,-6,-4,2,1,-2,-13,-10,0,3,5,4,11,5,4,-8,-5,2,16,7,10,-1,-3,0,3,-4,7,13,-9,-5,8,-1,11,4,-2,-1,5,7,1,6,7,8,-4,0,9,22,-1,-11,1,-1,-4,2,-5,-3,-6],[4,4,3,6,6,2,3,4,3,3,10,9,9,8,4,5,-4,6,2,8,1,7,6,2,-8,-6,1,-1,3,8,-1,1,-17,-9,-9,-6,-5,-7,1,-12,-22,-14,-12,-9,-6,-4,-2,-12,-23,-11,-12,-5,-2,1,-1,-30,-3,-7,-4,4,9,12,-20,-3],[-5,2,4,2,6,3,3,5,-13,-23,2,6,4,10,5,12,-7,-6,-2,3,12,16,17,22,-10,-11,-5,-5,7,6,9,14,-5,-13,-9,-8,-1,3,8,5,-9,-5,-2,-5,-5,5,2,4,-14,-8,3,7,8,6,-7,2,-6,-10,-4,13,-3,-13,-5,-6],[-1,0,0,0,0,0,1,0,0,2,1,2,2,2,1,0,1,3,3,3,2,6,5,1,0,2,4,3,3,4,3,-3,-3,1,3,1,1,0,-3,-9,-2,0,1,-3,-2,-6,-2,-11,-2,-1,-3,-25,-25,-13,13,14,-14,14,10,-29,7,-27,30,9]],[[0,0,0,0,0,0,0,0,50,47,35,28,25,25,31,39,35,32,22,5,2,9,22,21,8,0,-11,-27,-27,-21,-8,-10,-4,-4,-19,-26,-26,-24,-17,-19,-14,-9,-19,-17,-18,-19,-24,-26,-7,-9,-5,-11,-8,-18,-22,-26,0,0,0,0,0,0,0,0],[-10,-3,0,-3,1,-6,-4,-7,-5,3,-3,6,1,-4,-2,-5,-5,-2,2,1,1,1,1,-3,1,7,7,5,7,5,8,5,-1,0,2,9,3,3,6,-1,-3,-3,-11,2,-4,-17,-4,-2,-3,-2,-7,-5,1,-7,0,-2,-5,-13,-4,0,-2,-4,-9,-4],[-4,-2,-4,-2,-1,-2,-2,-3,-3,-1,0,-7,0,-3,-4,-7,1,-1,0,0,0,3,1,2,-2,4,4,11,5,4,-1,1,-1,-2,7,9,2,3,-3,-1,1,0,2,5,6,-3,-1,1,-3,-11,-7,-1,1,-5,-7,-4,-9,-1,-6,-2,-2,-4,-4,-5],[11,9,11,13,11,7,9,7,12,13,14,13,9,7,8,8,5,7,5,5,0,1,2,-2,-2,0,5,-2,-1,2,-2,0,-1,-2,1,-4,-6,-8,-6,-8,-8,-5,-9,-7,-11,-13,-6,-10,-7,-7,-5,-6,-9,-9,-7,-8,-10,-3,0,-7,-12,-13,-3,-21],[-5,2,4,3,6,4,2,4,-8,-5,4,7,7,7,3,4,-5,-3,0,7,11,11,7,9,-6,-1,1,8,12,6,9,8,-7,-2,3,13,8,6,6,4,-5,-8,1,-3,0,1,3,2,-7,-7,-14,-11,-9,-5,-6,-1,-6,-8,-7,-17,-5,-9,-4,-5],[-3,-2,-2,-1,0,1,2,-2,-2,6,6,6,6,12,7,0,1,12,14,12,11,23,21,3,-4,9,18,23,17,21,14,-5,-11,-4,14,20,19,15,2,-18,-13,-5,7,14,15,9,0,-16,-16,-9,2,6,10,3,-11,-25,-22,-25,-16,-15,-25,-12,-35,-44]]],this.PhaseValues=[0,1,1,2,4,0],this.MGdoubledPenalty=3,this.EGdoubledPenalty=10,this.MGisolatedPenalty=16,this.EGisolatedPenalty=4,this.MGfileSemiOpenScore=17,this.MGfileOpenScore=34,this.MGpassedBonus=[0,1,-4,-7,11,37,55,0],this.EGpassedBonus=[0,-9,-3,17,35,53,67,0],this.MGrookQueenFileBonus=11,this.MGKnightOutpostBonus=23,this.EGKnightOutpostBonus=14,this.MGBishopOutpostBonus=21,this.EGBishopOutpostBonus=0,this.MGCorneredBishopPenalty=25,this.EGCorneredBishopPenalty=40,this.MGKingSemiOpenPenalty=6,this.MGBishopPairBonus=25,this.EGBishopPairBonus=30,this.MGKnightMobility=[0,0,-23,-11,-9,0,15,0,24],this.MGBishopMobility=[0,-2,-28,-15,-8,0,5,13,17,18,21,23,11,8],this.MGRookMobility=[0,0,-31,-25,-22,-17,-14,-12,-11,-8,-1,2,10,17,16],this.MGQueenMobility=[0,0,0,0,-1,-5,-10,-11,-13,-9,-8,-8,-5,-3,-2,0,4,5,6,6,9,11,12,12,10,7,2,2],this.EGKnightMobility=[0,0,-25,-32,-18,0,-6,0,11],this.EGBishopMobility=[0,-1,-28,-29,-21,-16,-6,-1,6,8,11,10,11,10],this.EGRookMobility=[0,0,-26,-29,-19,-13,-6,-2,4,6,7,10,9,11,8],this.EGQueenMobility=[0,0,0,0,0,-1,-2,-3,-7,-8,-13,-13,-16,-15,-8,-4,-3,4,9,9,15,11,16,16,11,9,3,2],this.PhaseTotal=4*this.PhaseValues[1]+4*this.PhaseValues[2]+4*this.PhaseValues[3]+2*this.PhaseValues[4],this.KingSquares=[0,0],this.MaxPly=100,this.Checkmate=15e3,this.Inf=2e4,this.search={nodes:0,killers:Array(2).fill(0).map((()=>Array(this.MaxPly).fill(0))),history:Array(2).fill(0).map((()=>Array(64).fill(0).map((()=>Array(64).fill(0)))))},this.Timer={timeleft:-1,increment:0,depth:this.MaxPly,movestogo:0,startTime:0,stopTime:0,movetime:-1,stop:!1},this.totalNodes=0,this.Init(),this.InitHashes(),this.SetTransTableSize()}SetBit(s,i){return s|1n<<this.SquareBigInt[i]}RemoveBit(s,i){return s&~(1n<<this.SquareBigInt[i])}GetBit(s,i){return s&1n<<this.SquareBigInt[i]}CountBits(s){const i=Number(0xffffffffn&s),t=Number(s>>32n);function o(s){return 16843009*((s=(858993459&(s-=s>>1&1431655765))+(s>>2&858993459))+(s>>4)&252645135)>>24}return o(i)+o(t)}GetLS1B(s){return s?this.CountBits((s&-s)-1n):-1}PrintBitboard(s){for(let i=0;i<8;i++){let t="";for(let o=0;o<8;o++){const e=8*i+o;o||(t+=8-i+"  "),t+=" "+(this.GetBit(s,e)?"1":"0")}console.log(`${t} \r\n`)}console.log("\r\n    a b c d e f g h"),console.log(`    Bitboard: ${s}`)}LoadFEN(i){this.Position.PiecesBB=[[0n,0n,0n,0n,0n,0n],[0n,0n,0n,0n,0n,0n]],this.Position.OccupanciesBB=[0n,0n],this.Position.CastlingRights=0,this.Position.Squares=[],this.Position.EnPassSq=s.no_sq,this.Position.Phase=this.PhaseTotal,this.Position.CastlingSquaresMask=new Array(64).fill(15);const t=i.split(" ")[0].split("");let o=0;for(let s=0;s<t.length;s++){const i=t[s];switch(i){case"p":case"n":case"b":case"r":case"q":case"k":case"P":case"N":case"B":case"R":case"Q":case"K":{const s=this.CharToPiece.get(i);this.PlacePiece(s.Type,s.Color,o),this.Position.Phase-=this.PhaseValues[s.Type],o++;break}case"1":case"2":case"3":case"4":case"4":case"5":case"6":case"7":case"8":o+=parseInt(i);break;case"/":break;default:throw new Error(`Unable to parse FEN character: ${i}`)}}this.Position.SideToMove="w"===i.split(" ")[1]?0:1;const e=i.split(" ")[2].split("");for(const i of e){const t=i.toUpperCase()===i?0:1,o=this.GetLS1B(this.Position.PiecesBB[t][5]);if(this.Position.CastlingSquaresMask[o]=0===t?12:3,"K"===i.toUpperCase()){const i=this.Position.Squares.findIndex(((s,i)=>s&&3===s.Type&&s.Color===t&&i>o));0===t?(this.Position.CastlingRights|=1,this.Position.CastlingPaths[1]=(this.betweenMasks[o][s.g1]|this.betweenMasks[i][s.f1])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[1]=i,this.Position.CastlingSquaresMask[i]=14):(this.Position.CastlingRights|=4,this.Position.CastlingPaths[4]=(this.betweenMasks[o][s.g8]|this.betweenMasks[i][s.f8])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[4]=i,this.Position.CastlingSquaresMask[i]=11)}else if("Q"===i.toUpperCase()){const i=this.Position.Squares.findIndex(((s,i)=>s&&3===s.Type&&s.Color===t&&i<o));0===t?(this.Position.CastlingRights|=2,this.Position.CastlingPaths[2]=(this.betweenMasks[o][s.c1]|this.betweenMasks[i][s.d1])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[2]=i,this.Position.CastlingSquaresMask[i]=13):(this.Position.CastlingRights|=8,this.Position.CastlingPaths[8]=(this.betweenMasks[o][s.c8]|this.betweenMasks[i][s.d8])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[8]=i,this.Position.CastlingSquaresMask[i]=7)}else if(i.toUpperCase()>="A"&&i.toUpperCase()<="H")if(i.toUpperCase().charCodeAt(0)-65>(7&o)){const i=this.Position.Squares.findIndex(((s,i)=>s&&3===s.Type&&s.Color===t&&i>o));0===t?(this.Position.CastlingRights|=1,this.Position.CastlingPaths[1]=(this.betweenMasks[o][s.g1]|this.betweenMasks[i][s.f1])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[1]=i,this.Position.CastlingSquaresMask[i]=14):(this.Position.CastlingRights|=4,this.Position.CastlingPaths[4]=(this.betweenMasks[o][s.g8]|this.betweenMasks[i][s.f8])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[4]=i,this.Position.CastlingSquaresMask[i]=11)}else if(0===t){const i=this.Position.Squares.findIndex(((s,i)=>s&&3===s.Type&&s.Color===t&&i>=56&&i<o));this.Position.CastlingRights|=2,this.Position.CastlingPaths[2]=(this.betweenMasks[o][s.c1]|this.betweenMasks[i][s.d1])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[2]=i,this.Position.CastlingSquaresMask[i]=13}else{const i=this.Position.Squares.findIndex(((s,i)=>s&&3===s.Type&&s.Color===t&&i<o));this.Position.CastlingRights|=8,this.Position.CastlingPaths[8]=(this.betweenMasks[o][s.c8]|this.betweenMasks[i][s.d8])&~(this.Position.PiecesBB[t][5]|this.SetBit(0n,i)),this.Position.CastlingRookSquares[8]=i,this.Position.CastlingSquaresMask[i]=7}}const n=i.split(" ")[3];if("-"!==n){const s="abcdefgh".indexOf(n.split("")[0]),i=8*(8-parseInt(n[1],10))+s;this.PawnAttacks[1^this.Position.SideToMove][i]&this.Position.PiecesBB[this.Position.SideToMove][0]&&(this.Position.EnPassSq=i)}this.Position.Ply=2*parseInt(i.split(" ")[5])||0,1===this.Position.SideToMove&&this.Position.Ply--,this.Position.HalfMoves=parseInt(i.split(" ")[4])||0;const{hash:h,pawnHash:a}=this.GenerateHashes();this.Position.Hash=h,this.Position.PawnHash=a,this.PositionHistory.length=0,this.PositionHistory[0]=this.Position.Hash,this.KingSquares[0]=0,this.KingSquares[1]=0}PrintBoard(){const i=[["♙","♘","♗","♖","♕","♔"],["♟︎","♞","♝","♜","♛","♚"]];for(let s=0;s<8;s++){let t="";for(let o=0;o<8;o++){let e=8*s+o,n=this.Position.Squares[e]??null;o||(t+=8-s+" "),t+=n?` ${i[n.Color][n.Type]}`:" . "}console.log(`${t} \r\n`)}console.log("\r\n   a  b  c  d  e  f  g  h"),console.log("Side to move: "+(0===this.Position.SideToMove?"white":"black")),console.log(`En passant: ${this.Position.EnPassSq!==s.no_sq?s[this.Position.EnPassSq]:"no"}`),console.log(`Castling rights: ${1&this.Position.CastlingRights?"K":"-"}${2&this.Position.CastlingRights?"Q":"-"}${4&this.Position.CastlingRights?"k":"-"}${8&this.Position.CastlingRights?"q":"-"}`),console.log(`Plies: ${this.Position.Ply}`)}GenerateMoves(s=!1){const i=[];let t=-1n;s?(t=this.Position.OccupanciesBB[1^this.Position.SideToMove],this.GeneratePawnAttacks(i)):(this.GeneratePawnMoves(i),this.GenerateCastlingMoves(i));for(let s=1;s<=5;s++){let o=this.Position.PiecesBB[this.Position.SideToMove][s];for(;o;){const e=this.GetLS1B(o);switch(s){case 1:this.GenerateKnightMoves(i,e,t);break;case 2:this.GenerateBishopMoves(i,e,t);break;case 3:this.GenerateRookMoves(i,e,t);break;case 4:this.GenerateQueenMoves(i,e,t);break;case 5:this.GenerateKingMoves(i,e,t)}o=this.RemoveBit(o,e)}}return i}GeneratePawnMoves(i){let t=this.Position.PiecesBB[this.Position.SideToMove][0];const o=~(this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1]);let e=(0===this.Position.SideToMove?t>>8n:t<<8n)&o,n=e>>8n&0x000000ff00000000n&o;for(1===this.Position.SideToMove&&(n=e<<8n&0x00000000ff000000n&o);e;){const t=this.GetLS1B(e),o=0===this.Position.SideToMove?t+8:t-8;(0===this.Position.SideToMove?t<=s.h8:t>=s.a1)?(i.push(this.EncodeMove(o,t,1,0)),i.push(this.EncodeMove(o,t,1,1)),i.push(this.EncodeMove(o,t,1,2)),i.push(this.EncodeMove(o,t,1,3))):i.push(this.EncodeMove(o,t,0)),e=this.RemoveBit(e,t)}for(;n;){const s=this.GetLS1B(n),t=0===this.Position.SideToMove?s+16:s-16;i.push(this.EncodeMove(t,s,0)),n=this.RemoveBit(n,s)}for(;t;){const o=this.GetLS1B(t);let e=this.PawnAttacks[this.Position.SideToMove][o]&this.Position.OccupanciesBB[1^this.Position.SideToMove];for(;e;){const t=this.GetLS1B(e);(0===this.Position.SideToMove?t<=s.h8:t>=s.a1)?(i.push(this.EncodeMove(o,t,1,0)),i.push(this.EncodeMove(o,t,1,1)),i.push(this.EncodeMove(o,t,1,2)),i.push(this.EncodeMove(o,t,1,3))):i.push(this.EncodeMove(o,t,0)),e=this.RemoveBit(e,t)}if(this.Position.EnPassSq!==s.no_sq){const s=this.PawnAttacks[this.Position.SideToMove][o]&1n<<this.SquareBigInt[this.Position.EnPassSq];if(s){const t=this.GetLS1B(s);i.push(this.EncodeMove(o,t,2))}}t=this.RemoveBit(t,o)}}GeneratePawnAttacks(i){let t=this.Position.PiecesBB[this.Position.SideToMove][0];for(;t;){const o=this.GetLS1B(t);let e=this.PawnAttacks[this.Position.SideToMove][o]&this.Position.OccupanciesBB[1^this.Position.SideToMove];for(;e;){const t=this.GetLS1B(e);(0===this.Position.SideToMove?t<=s.h8:t>=s.a1)?(i.push(this.EncodeMove(o,t,1,0)),i.push(this.EncodeMove(o,t,1,1)),i.push(this.EncodeMove(o,t,1,2)),i.push(this.EncodeMove(o,t,1,3))):i.push(this.EncodeMove(o,t,0)),e=this.RemoveBit(e,t)}if(this.Position.EnPassSq!==s.no_sq){const s=this.PawnAttacks[this.Position.SideToMove][o]&1n<<this.SquareBigInt[this.Position.EnPassSq];if(s){const t=this.GetLS1B(s);i.push(this.EncodeMove(o,t,2))}}t=this.RemoveBit(t,o)}}GenerateCastlingMoves(i){const t=this.GetLS1B(this.Position.PiecesBB[this.Position.SideToMove][5]);if(this.IsSquareAttacked(t,1^this.Position.SideToMove))return;const o=this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1];if(0===this.Position.SideToMove){if(1&this.Position.CastlingRights){let e=this.betweenMasks[t][s.g1];if(0n===(this.Position.CastlingPaths[1]&o)){let s=!0;for(;s&&e;){const i=this.GetLS1B(e);e=this.RemoveBit(e,i),this.IsSquareAttacked(i,1^this.Position.SideToMove)&&(s=!1)}s&&i.push(this.EncodeMove(t,this.Position.CastlingRookSquares[1],3))}}if(2&this.Position.CastlingRights){let e=this.betweenMasks[t][s.c1];if(0n===(this.Position.CastlingPaths[2]&o)){let s=!0;for(;s&&e;){const i=this.GetLS1B(e);e=this.RemoveBit(e,i),this.IsSquareAttacked(i,1^this.Position.SideToMove)&&(s=!1)}s&&i.push(this.EncodeMove(t,this.Position.CastlingRookSquares[2],3))}}}else{if(4&this.Position.CastlingRights){let e=this.betweenMasks[t][s.g8];if(0n===(this.Position.CastlingPaths[4]&o)){let s=!0;for(;s&&e;){const i=this.GetLS1B(e);e=this.RemoveBit(e,i),this.IsSquareAttacked(i,1^this.Position.SideToMove)&&(s=!1)}s&&i.push(this.EncodeMove(t,this.Position.CastlingRookSquares[4],3))}}if(8&this.Position.CastlingRights){let e=this.betweenMasks[t][s.c8];if(0n===(this.Position.CastlingPaths[8]&o)){let s=!0;for(;s&&e;){const i=this.GetLS1B(e);e=this.RemoveBit(e,i),this.IsSquareAttacked(i,1^this.Position.SideToMove)&&(s=!1)}s&&i.push(this.EncodeMove(t,this.Position.CastlingRookSquares[8],3))}}}}GenerateKnightMoves(s,i,t){let o=this.KnightAttacks[i]&~this.Position.OccupanciesBB[this.Position.SideToMove]&t;for(;o;){const t=this.GetLS1B(o);s.push(this.EncodeMove(i,t,0)),o=this.RemoveBit(o,t)}}GenerateBishopAttacks(s,i){return s=BigInt.asUintN(64,s&this.BishopMasks[i]),s=BigInt.asUintN(64,s*this.BishopMagicNumbers[i]),s>>=64n-this.BishopRelevantBits[i],this.BishopAttacks[i][Number(s)]}GenerateBishopMoves(s,i,t){let o=this.GenerateBishopAttacks(this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1],i)&~this.Position.OccupanciesBB[this.Position.SideToMove]&t;for(;o;){const t=this.GetLS1B(o);s.push(this.EncodeMove(i,t,0)),o=this.RemoveBit(o,t)}}GenerateRookAttacks(s,i){return s=BigInt.asUintN(64,s&this.RookMasks[i]),s=BigInt.asUintN(64,s*this.RookMagicNumbers[i]),s>>=64n-this.RookRelevantBits[i],this.RookAttacks[i][Number(s)]}GenerateRookMoves(s,i,t){let o=this.GenerateRookAttacks(this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1],i)&~this.Position.OccupanciesBB[this.Position.SideToMove]&t;for(;o;){const t=this.GetLS1B(o);s.push(this.EncodeMove(i,t,0)),o=this.RemoveBit(o,t)}}GenerateQueenMoves(s,i,t){const o=this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1];let e=(this.GenerateBishopAttacks(o,i)|this.GenerateRookAttacks(o,i))&~this.Position.OccupanciesBB[this.Position.SideToMove]&t;for(;e;){const t=this.GetLS1B(e);s.push(this.EncodeMove(i,t,0)),e=this.RemoveBit(e,t)}}GenerateKingMoves(s,i,t){let o=this.KingAttacks[i]&~this.Position.OccupanciesBB[this.Position.SideToMove]&t;for(;o;){const t=this.GetLS1B(o);s.push(this.EncodeMove(i,t,0)),o=this.RemoveBit(o,t)}}EncodeMove(s,i,t,o=0){return s|i<<6|t<<12|o<<14}MoveIsCapture(s){const i=(16256&s)>>12;return 3!==i&&void 0!==this.Position.Squares[(4032&s)>>6]||2===i}MoveIsPromotion(s){return(16256&s)>>12==1}IsSquareAttacked(s,i){const t=this.Position.PiecesBB[i][2],o=this.Position.PiecesBB[i][3],e=this.Position.PiecesBB[i][4];if(this.PawnAttacks[1^i][s]&this.Position.PiecesBB[i][0])return!0;if(this.KnightAttacks[s]&this.Position.PiecesBB[i][1])return!0;const n=this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1],h=t|e;if(this.attackRays[0][s]&h&&this.GenerateBishopAttacks(n,s)&h)return!0;const a=o|e;return!!(this.attackRays[1][s]&a&&this.GenerateRookAttacks(n,s)&a)||!!(this.KingAttacks[s]&this.Position.PiecesBB[i][5])}MakeMove(i){const t=63&i,o=(4032&i)>>6,e=(16256&i)>>12,n=this.Position.Squares[t];let h=2===e?{Type:0,Color:1^this.Position.SideToMove}:this.Position.Squares[o];if(this.stateCopy.push({CastlingRights:this.Position.CastlingRights,EnPassSq:this.Position.EnPassSq,Captured:h,Hash:this.Position.Hash,PawnHash:this.Position.PawnHash,HalfMoves:this.Position.HalfMoves,Phase:this.Position.Phase}),this.Position.Ply++,this.Position.HalfMoves++,this.Position.EnPassSq!==s.no_sq&&(this.Position.Hash^=this.Zobrist.EnPassant[this.Position.EnPassSq],this.Position.EnPassSq=s.no_sq),3===e)this.DoCastle(n,t,o);else{if(void 0!==h||2===e){let s=o;2===e&&(s=0===n.Color?o+8:o-8,h={Type:0,Color:1^n.Color}),this.RemovePiece(h.Type,h.Color,s),this.Position.HalfMoves=0,this.Position.Hash^=this.Zobrist.Pieces[h.Color][h.Type][o],this.Position.Phase+=this.PhaseValues[h.Type],0===h.Type&&(this.Position.PawnHash^=this.Zobrist.Pieces[h.Color][h.Type][o])}if(this.MovePiece(n,t,o),this.Position.Hash^=this.Zobrist.Pieces[n.Color][n.Type][t]^this.Zobrist.Pieces[n.Color][n.Type][o],0===n.Type)if(this.Position.HalfMoves=0,this.Position.PawnHash^=this.Zobrist.Pieces[n.Color][n.Type][t]^this.Zobrist.Pieces[n.Color][n.Type][o],1===e){const s={Type:1+(i>>14),Color:n.Color};this.RemovePiece(n.Type,n.Color,o),this.PlacePiece(s.Type,s.Color,o),this.Position.Phase+=this.PhaseValues[0],this.Position.Phase-=this.PhaseValues[s.Type],this.Position.Hash^=this.Zobrist.Pieces[n.Color][n.Type][o]^this.Zobrist.Pieces[s.Color][s.Type][o],this.Position.PawnHash^=this.Zobrist.Pieces[n.Color][n.Type][o]}else 16==(o^t)&&(this.Position.EnPassSq=0===n.Color?o+8:o-8,this.Position.Hash^=this.Zobrist.EnPassant[this.Position.EnPassSq])}return this.Position.Hash^=this.Zobrist.Castle[this.Position.CastlingRights],this.Position.CastlingRights&=this.Position.CastlingSquaresMask[t]&this.Position.CastlingSquaresMask[o],this.Position.Hash^=this.Zobrist.Castle[this.Position.CastlingRights],this.Position.SideToMove^=1,this.Position.Hash^=this.Zobrist.SideToMove,this.Position.EnPassSq!==s.no_sq&&(this.Position.Hash^=this.Zobrist.EnPassant[this.Position.EnPassSq]),this.PositionHistory[this.PositionHistory.length]=this.Position.Hash,!this.IsSquareAttacked(this.GetLS1B(this.Position.PiecesBB[1^this.Position.SideToMove][5]),this.Position.SideToMove)}UnmakeMove(s){const i=this.stateCopy.pop();this.Position.Ply--,this.PositionHistory.pop(),this.Position.CastlingRights=i.CastlingRights,this.Position.EnPassSq=i.EnPassSq,this.Position.HalfMoves=i.HalfMoves,this.Position.Phase=i.Phase,this.Position.SideToMove^=1;const t=63&s,o=(4032&s)>>6,e=(16256&s)>>12,n=this.Position.Squares[o];if(3===e)this.UndoCastle(t,o);else if(1===e)this.RemovePiece(n.Type,n.Color,o),this.PlacePiece(0,n.Color,t),i.Captured&&this.PlacePiece(i.Captured.Type,i.Captured.Color,o);else if(this.MovePiece(n,o,t),i.Captured){let s=o,t=i.Captured;2===e&&(s=0===n.Color?o+8:o-8),this.PlacePiece(t.Type,t.Color,s)}this.Position.Hash=i.Hash,this.Position.PawnHash=i.PawnHash}DoCastle(i,t,o){const e=o>t;let n=s.g1^56*i.Color,h=s.f1^56*i.Color;e||(n=s.c1^56*i.Color,h=s.d1^56*i.Color);const a=o;this.RemovePiece(3,i.Color,a),this.RemovePiece(i.Type,i.Color,t),this.PlacePiece(3,i.Color,h),this.PlacePiece(i.Type,i.Color,n),this.Position.Hash^=this.Zobrist.Pieces[i.Color][3][a]^this.Zobrist.Pieces[i.Color][3][h]}UndoCastle(i,t){const o=this.Position.SideToMove,e=t>i;let n=s.g1^56*o,h=s.f1^56*o;e||(n=s.c1^56*o,h=s.d1^56*o);const a=t;this.RemovePiece(3,o,h),this.RemovePiece(5,o,n),this.PlacePiece(3,o,a),this.PlacePiece(5,o,i)}MakeNullMove(){this.stateCopy.push({CastlingRights:this.Position.CastlingRights,EnPassSq:this.Position.EnPassSq,Hash:this.Position.Hash,HalfMoves:this.Position.HalfMoves,PawnHash:this.Position.PawnHash,Phase:this.Position.Phase}),this.Position.EnPassSq!==s.no_sq&&(this.Position.Hash^=this.Zobrist.EnPassant[this.Position.EnPassSq],this.Position.EnPassSq=s.no_sq),this.Position.HalfMoves=0,this.Position.SideToMove^=1,this.Position.Hash^=this.Zobrist.SideToMove,this.Position.Ply++}UnmakeNullMove(){const s=this.stateCopy.pop();this.Position.CastlingRights=s.CastlingRights,this.Position.EnPassSq=s.EnPassSq,this.Position.HalfMoves=s.HalfMoves,this.Position.SideToMove^=1,this.Position.Hash=s.Hash,this.Position.PawnHash=s.PawnHash,this.Position.Ply--,this.Position.Phase=s.Phase}MovePiece(s,i,t){const o=this.squareBB[i]|this.squareBB[t];this.Position.PiecesBB[s.Color][s.Type]^=o,this.Position.OccupanciesBB[s.Color]^=o,delete this.Position.Squares[i],this.Position.Squares[t]=s}RemovePiece(s,i,t){this.Position.PiecesBB[i][s]=this.RemoveBit(this.Position.PiecesBB[i][s],t),this.Position.OccupanciesBB[i]=this.RemoveBit(this.Position.OccupanciesBB[i],t),delete this.Position.Squares[t]}PlacePiece(s,i,t){this.Position.PiecesBB[i][s]=this.SetBit(this.Position.PiecesBB[i][s],t),this.Position.OccupanciesBB[i]=this.SetBit(this.Position.OccupanciesBB[i],t),this.Position.Squares[t]={Type:s,Color:i}}PrettyPrintMove(i){const t=63&i;let o=(4032&i)>>6;const e=(16256&i)>>12;3!==e||this.isChess960||(o=o>t?o-1:o+2);let n=`${s[t]}${s[o]}`;if(1===e){const s=i>>14;0===s&&(n+="n"),1===s&&(n+="b"),2===s&&(n+="r"),3===s&&(n+="q")}return n}Init(){for(let i=s.a8;i<=s.h1;i++){this.squareBB[i]=this.SetBit(0n,i),this.rankMasks[i]=0xffn<<(56n&BigInt(i)),this.fileMasks[i]=0x0101010101010101n<<(7n&BigInt(i)),this.isolatedMasks[i]=this.fileMasks[i]<<1n|this.fileMasks[i]>>1n,this.PawnAttacks[0][i]=this.MaskPawnAttacks(0,i),this.PawnAttacks[1][i]=this.MaskPawnAttacks(1,i),this.KnightAttacks[i]=this.MaskKnightAttacks(i),this.KingAttacks[i]=this.MaskKingAttacks(i),this.BishopMasks[i]=this.GenerateBishopMasks(i);let s=this.CountBits(this.BishopMasks[i]),t=1<<s;for(let o=0;o<t;o++){const t=this.SetOccupancy(o,s,this.BishopMasks[i]),e=BigInt.asUintN(64,t*this.BishopMagicNumbers[i])>>64n-this.BishopRelevantBits[i];this.BishopAttacks[i][Number(e)]=this.GenerateBishopAttacksFly(i,t)}this.RookMasks[i]=this.GenerateRookMasks(i),s=this.CountBits(this.RookMasks[i]),t=1<<s;for(let o=0;o<t;o++){const t=this.SetOccupancy(o,s,this.RookMasks[i]),e=BigInt.asUintN(64,t*this.RookMagicNumbers[i])>>64n-this.RookRelevantBits[i];this.RookAttacks[i][Number(e)]=this.GenerateRookAttacksFly(i,t)}this.attackRays[0][i]=this.GenerateBishopAttacks(0n,i),this.attackRays[2][i]|=this.attackRays[0][i],this.attackRays[1][i]=this.GenerateRookAttacks(0n,i),this.attackRays[2][i]|=this.attackRays[1][i];let o=this.fileMasks[i]|(this.fileMasks[i]&this.notAFile)>>1n|(this.fileMasks[i]&this.notHFile)<<1n;this.passedMasks[0][i]=o,this.passedMasks[1][56^i]=o,o=0n;for(let s=0;s<64;s++){const t=i>>3,e=s>>3,n=7&i,h=7&s;if(this.distanceBetween[i][s]=Math.max(Math.abs(e-t),Math.abs(h-n)),i!==s){if(i<s){o=this.SetBit(0n,i+1);for(let t=i+1;t<=s;t++)o|=0x0001n<<BigInt(t)}else{o=this.SetBit(0n,i-1);for(let t=i-1;t>=s;t--)o|=0x0001n<<BigInt(t)}this.betweenMasks[i][s]=o}}}for(let i=s.a8;i<=s.h1;i++){for(let t=i;t<=s.h1;t+=8)this.passedMasks[0][i]&=~this.rankMasks[t];for(let t=i;t>=s.a8;t-=8)this.passedMasks[1][56^i]&=~this.rankMasks[t]}}MaskPawnAttacks(s,i){let t=0n,o=0n;return o=this.SetBit(o,i),s?(o<<7n&this.notHFile&&(t|=o<<7n),o<<9n&this.notAFile&&(t|=o<<9n)):(o>>7n&this.notAFile&&(t|=o>>7n),o>>9n&this.notHFile&&(t|=o>>9n)),BigInt.asUintN(64,t)}MaskKnightAttacks(s){let i=0n,t=0n;return t=this.SetBit(t,s),t>>17n&this.notHFile&&(i|=t>>17n),t>>15n&this.notAFile&&(i|=t>>15n),t>>10n&this.notHGFile&&(i|=t>>10n),t>>6n&this.notABFile&&(i|=t>>6n),t<<17n&this.notAFile&&(i|=t<<17n),t<<15n&this.notHFile&&(i|=t<<15n),t<<10n&this.notABFile&&(i|=t<<10n),t<<6n&this.notHGFile&&(i|=t<<6n),BigInt.asUintN(64,i)}GenerateBishopMasks(s){let i=0n;const t=Math.floor(s/8),o=s%8;for(let s=t+1,e=o+1;s<=6&&e<=6;s++,e++)i|=1n<<8n*BigInt(s)+BigInt(e);for(let s=t-1,e=o+1;s>=1&&e<=6;s--,e++)i|=1n<<8n*BigInt(s)+BigInt(e);for(let s=t+1,e=o-1;s<=6&&e>=1;s++,e--)i|=1n<<8n*BigInt(s)+BigInt(e);for(let s=t-1,e=o-1;s>=1&&e>=1;s--,e--)i|=1n<<8n*BigInt(s)+BigInt(e);return BigInt.asUintN(64,i)}GenerateBishopAttacksFly(s,i){let t=0n;const o=Math.floor(s/8),e=s%8;for(let s=o+1,n=e+1;s<=7&&n<=7&&(t|=1n<<8n*BigInt(s)+BigInt(n),!(1n<<8n*BigInt(s)+BigInt(n)&i));s++,n++);for(let s=o-1,n=e+1;s>=0&&n<=7&&(t|=1n<<8n*BigInt(s)+BigInt(n),!(1n<<8n*BigInt(s)+BigInt(n)&i));s--,n++);for(let s=o+1,n=e-1;s<=7&&n>=0&&(t|=1n<<8n*BigInt(s)+BigInt(n),!(1n<<8n*BigInt(s)+BigInt(n)&i));s++,n--);for(let s=o-1,n=e-1;s>=0&&n>=0&&(t|=1n<<8n*BigInt(s)+BigInt(n),!(1n<<8n*BigInt(s)+BigInt(n)&i));s--,n--);return BigInt.asUintN(64,t)}GenerateRookMasks(s){let i=0n;const t=Math.floor(s/8),o=s%8;for(let s=t+1;s<=6;s++)i|=1n<<8n*BigInt(s)+BigInt(o);for(let s=t-1;s>=1;s--)i|=1n<<8n*BigInt(s)+BigInt(o);for(let s=o+1;s<=6;s++)i|=1n<<8n*BigInt(t)+BigInt(s);for(let s=o-1;s>=1;s--)i|=1n<<8n*BigInt(t)+BigInt(s);return BigInt.asUintN(64,i)}GenerateRookAttacksFly(s,i){let t=0n;const o=Math.floor(s/8),e=s%8;for(let s=o+1;s<=7&&(t|=1n<<8n*BigInt(s)+BigInt(e),!(1n<<8n*BigInt(s)+BigInt(e)&i));s++);for(let s=o-1;s>=0&&(t|=1n<<8n*BigInt(s)+BigInt(e),!(1n<<8n*BigInt(s)+BigInt(e)&i));s--);for(let s=e+1;s<=7&&(t|=1n<<8n*BigInt(o)+BigInt(s),!(1n<<8n*BigInt(o)+BigInt(s)&i));s++);for(let s=e-1;s>=0&&(t|=1n<<8n*BigInt(o)+BigInt(s),!(1n<<8n*BigInt(o)+BigInt(s)&i));s--);return BigInt.asUintN(64,t)}MaskKingAttacks(s){let i=0n,t=0n;return t=this.SetBit(t,s),t>>8n&&(i|=t>>8n),t>>9n&this.notHFile&&(i|=t>>9n),t>>7n&this.notAFile&&(i|=t>>7n),t>>1n&this.notHFile&&(i|=t>>1n),t<<8n&&(i|=t<<8n),t<<9n&this.notAFile&&(i|=t<<9n),t<<7n&this.notHFile&&(i|=t<<7n),t<<1n&this.notAFile&&(i|=t<<1n),BigInt.asUintN(64,i)}SetOccupancy(s,i,t){let o=0n;for(let e=0;e<i;e++){const i=this.GetLS1B(t);t=this.RemoveBit(t,i),s&1<<e&&(o|=1n<<this.SquareBigInt[i])}return BigInt.asUintN(64,o)}Random64(){let s=this.PRNG_SEED;return s^=s>>12n,s^=s<<25n,s^=s>>27n,this.PRNG_SEED=s,BigInt.asUintN(64,2685821657736338717n*s)}InitHashes(){for(let i=0;i<=5;i++)for(let t=s.a8;t<=s.h1;t++)this.Zobrist.Pieces[0][i][t]=this.Random64(),this.Zobrist.Pieces[1][i][t]=this.Random64();for(let i=s.a8;i<=s.h1;i++)this.Zobrist.EnPassant[i]=this.Random64();for(let s=0;s<16;s++)this.Zobrist.Castle[s]=this.Random64();this.Zobrist.SideToMove=this.Random64()}GenerateHashes(){let i=0n,t=0n;for(let o=s.a8;o<=s.h1;o++){const s=this.Position.Squares[o];s&&(i^=this.Zobrist.Pieces[s.Color][s.Type][o],0===s.Type&&(t^=this.Zobrist.Pieces[s.Color][0][o]))}return this.Position.EnPassSq!==s.no_sq&&(i^=this.Zobrist.EnPassant[this.Position.EnPassSq]),i^=this.Zobrist.Castle[this.Position.CastlingRights],1===this.Position.SideToMove&&(i^=this.Zobrist.SideToMove),{hash:i,pawnHash:t}}SetTransTableSize(s=32){this.TranspositionTables.Size=BigInt(1024*s*1024/16),this.TranspositionTables.Entries.length=0,this.PawnHashTable.Size=BigInt(65536),this.PawnHashTable.Entries.length=0}WriteTT(s,i,t,o){const e=Number(this.Position.Hash%this.TranspositionTables.Size);t>this.Checkmate&&(t+=this.Position.Ply),t<-this.Checkmate&&(t-=this.Position.Ply),this.TranspositionTables.Entries[e]={BestMove:o,Depth:s,Flag:i,Hash:this.Position.Hash,Score:t}}ProbeTT(s,i,t){const o=this.TranspositionTables.Entries[Number(this.Position.Hash%this.TranspositionTables.Size)];let e=this.HashNoMove;if(!o||o.Hash!==this.Position.Hash)return{ttScore:e,ttMove:0};if(o.Depth>=s){let s=o.Score;s>this.Checkmate&&(s-=this.Position.Ply),s<-this.Checkmate&&(s+=this.Position.Ply),0===o.Flag&&(e=s),1===o.Flag&&s<=i&&(e=s),2===o.Flag&&s>=t&&(e=s)}return{ttScore:e,ttMove:o.BestMove}}Evaluate(){let i=[0,0],t=[0,0],o=this.Position.Phase;const e=[0,0],n=this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1];let h=n&~(this.Position.PiecesBB[0][0]|this.Position.PiecesBB[1][0]);const a=this.PawnHashTable.Entries[Number(this.Position.PawnHash%this.PawnHashTable.Size)];if(a&&a.hash===this.Position.PawnHash)i[0]+=a.wScore.mg,t[0]+=a.wScore.eg,i[1]+=a.bScore.mg,t[1]+=a.bScore.eg;else{const s=this.EvaluatePawns();i[0]+=s.mgScores[0],t[0]+=s.egScores[0],i[1]+=s.mgScores[1],t[1]+=s.egScores[1],this.PawnHashTable.Entries[Number(this.Position.PawnHash%this.PawnHashTable.Size)]={hash:this.Position.PawnHash,wScore:{mg:s.mgScores[0],eg:s.egScores[0]},bScore:{mg:s.mgScores[1],eg:s.egScores[1]}}}const r=[this.rankMasks[s.a4]|this.rankMasks[s.a5]|this.rankMasks[s.a6],this.rankMasks[s.a3]|this.rankMasks[s.a4]|this.rankMasks[s.a5]];for(;h;){let o=this.GetLS1B(h),a=o;h=this.RemoveBit(h,o);const P=this.Position.Squares[o];switch(1===P.Color&&(o^=56),i[P.Color]+=this.PST[0][P.Type][o]+this.MGPieceValue[P.Type],t[P.Color]+=this.PST[1][P.Type][o]+this.EGPieceValue[P.Type],P.Type){case 1:{r[P.Color]&this.squareBB[a]&&0n===(this.passedMasks[P.Color][a]&~this.fileMasks[a]&this.Position.PiecesBB[1^P.Color][0])&&this.PawnAttacks[1^P.Color][a]&this.Position.PiecesBB[P.Color][0]&&(i[P.Color]+=this.MGKnightOutpostBonus,t[P.Color]+=this.EGKnightOutpostBonus);const s=this.KnightAttacks[a],o=this.CountBits(s);i[P.Color]+=this.MGKnightMobility[o],t[P.Color]+=this.EGKnightMobility[o];break}case 2:{e[P.Color]++;const h=this.GenerateBishopAttacks(n,a),l=this.CountBits(h);if(i[P.Color]+=this.MGBishopMobility[l],t[P.Color]+=this.EGBishopMobility[l],r[P.Color]&this.squareBB[a]&&0n===(this.passedMasks[P.Color][a]&~this.fileMasks[a]&this.Position.PiecesBB[1^P.Color][0])&&this.PawnAttacks[1^P.Color][a]&this.Position.PiecesBB[P.Color][0]&&(i[P.Color]+=this.MGBishopOutpostBonus,t[P.Color]+=this.EGBishopOutpostBonus),this.isChess960&&(o===s.a1||o===s.h1)){let s=0==(7&o)?1n<<49n:1n<<54n;1===P.Color&&(s>>=40n),0n!==(s&this.Position.PiecesBB[P.Color][0])&&(i[P.Color]-=this.MGCorneredBishopPenalty,t[P.Color]-=this.EGCorneredBishopPenalty)}break}case 3:{const s=this.GenerateRookAttacks(n,a),e=this.CountBits(s);i[P.Color]+=this.MGRookMobility[e],t[P.Color]+=this.EGRookMobility[e],0n===(this.Position.PiecesBB[P.Color][0]&this.fileMasks[o])&&(0n===(this.Position.PiecesBB[1^P.Color][0]&this.fileMasks[o])?i[P.Color]+=this.MGfileOpenScore:i[P.Color]+=this.MGfileSemiOpenScore),this.fileMasks[o]&this.Position.PiecesBB[1^P.Color][4]&&(i[P.Color]+=this.MGrookQueenFileBonus);break}case 4:{const s=this.GenerateBishopAttacks(n,a)|this.GenerateRookAttacks(n,a),o=this.CountBits(s);i[P.Color]+=this.MGQueenMobility[o],t[P.Color]+=this.EGQueenMobility[o];break}case 5:if(a!==this.KingSquares[P.Color]){this.KingSquares[P.Color]=a;const s=Math.min(Math.max(7&o,1),6);let t=1;for(let o=s-1;o<=s+1;o++)0n===(this.fileMasks[o]&this.Position.PiecesBB[P.Color][0])&&(i[P.Color]-=this.MGKingSemiOpenPenalty*t*t,t++)}}}return e[0]>=2&&(i[0]+=this.MGBishopPairBonus,t[0]+=this.EGBishopPairBonus),e[1]>=2&&(i[1]+=this.MGBishopPairBonus,t[1]+=this.EGBishopPairBonus),o=(256*o+this.PhaseTotal/2)/this.PhaseTotal|0,((i[this.Position.SideToMove]-i[1^this.Position.SideToMove])*(256-o)+(t[this.Position.SideToMove]-t[1^this.Position.SideToMove])*o)/256|0}EvaluatePawns(){let s=[0,0],i=[0,0],t=this.Position.PiecesBB[0][0]|this.Position.PiecesBB[1][0];for(;t;){let o=this.GetLS1B(t);t=this.RemoveBit(t,o);const e=this.Position.Squares[o];1===e.Color&&(o^=56),s[e.Color]+=this.PST[0][0][o]+this.MGPieceValue[0],i[e.Color]+=this.PST[1][0][o]+this.EGPieceValue[0];const n=this.Position.PiecesBB[e.Color][0]&this.fileMasks[o];if(0n!==(n&n-1n)&&(s[e.Color]-=this.MGdoubledPenalty,i[e.Color]-=this.EGdoubledPenalty),0n===(this.Position.PiecesBB[e.Color][0]&this.isolatedMasks[o])&&(s[e.Color]-=this.MGisolatedPenalty,i[e.Color]-=this.EGisolatedPenalty),0n===(this.passedMasks[e.Color][o]&this.Position.PiecesBB[1^e.Color][0])){const t=7-(o>>3);s[e.Color]+=this.MGpassedBonus[t],i[e.Color]+=this.EGpassedBonus[t]}}return{mgScores:s,egScores:i}}Search(s){this.search.nodes=0;let i={moves:[]},t="";this.StartTimer();let o=-this.Inf,e=this.Inf,n=-this.Inf;this.AgeHistory();const h=Date.now(),a=()=>n<-this.Checkmate?"mate "+(-this.Inf-n)/2:n>this.Checkmate?"mate "+(this.Inf-n+1)/2:`cp ${n}`;this.Position.Ply=0;for(let r=1;r<=s;r++){i.moves.length=0;let s=r>=4?25:this.Inf;for(;!(this.Timer.stop||(o=Math.max(n-s,-this.Inf),e=Math.min(n+s,this.Inf),n=this.Negamax(r,o,e,i),n>o&&n<e));)s*=3;const P=Date.now();if(this.Timer.stop)break;if(t=this.PrettyPrintMove(i.moves[0]),console.log(`info depth ${r} score ${a()} nodes ${this.search.nodes} time ${P-h} pv ${i.moves.map((s=>this.PrettyPrintMove(s))).join(" ")}`),n>this.Checkmate||n<-this.Checkmate)break}return console.log(`bestmove ${t}`),t}Negamax(s,i,t,o,e=!0){let n=-this.Inf,h=1,a=0,r=!1;const P=t-i>1,l=this.IsSquareAttacked(this.GetLS1B(this.Position.PiecesBB[this.Position.SideToMove][5]),1^this.Position.SideToMove),c={moves:[]};if(this.search.nodes++,this.search.nodes%1e3==0&&this.CheckTime(),this.Timer.stop)return 0;if(l&&(s+=1),s<=0)return this.Quiescence(i,t,s);if(this.Position.Ply>0&&(this.IsRepetition()||this.Position.HalfMoves>=100))return 0;const{ttScore:B,ttMove:p}=this.ProbeTT(s,i,t);if(B!==this.HashNoMove&&0!==this.Position.Ply)return B;let M=p;if(!l&&!P){const o=this.Evaluate();if(o-90*s>=t)return o-90*s;if(s<=2&&o+90*s<=i&&(r=!0),e&&s>=2&&o>=t){this.MakeNullMove();const i=3+Math.floor(s/5);let o=-this.Negamax(s-1-i,-t,1-t,c,!1);if(this.UnmakeNullMove(),c.moves.length=0,o>=t)return t}}let u=this.GenerateMoves();u=this.SortMoves(u,p);for(let e=0;e<u.length;e++){const B=u[e],p=this.MoveIsCapture(B);if(r&&a>1&&!p&&!this.MoveIsPromotion(B))continue;if(!l&&p&&this.See(B)<-300*s)continue;if(!this.MakeMove(B)){this.UnmakeMove(B);continue}a++;let g=0,k=0;if(s>=2&&a>1?(k=.45*Math.log(s*a**2),P&&(k-=1+s/(3*s)),k=Math.round(Math.max(1,k)),g=-this.Negamax(s-1-k,-i-1,-i,c),g>i&&(g=-this.Negamax(s-1,-t,-i,c))):g=-this.Negamax(s-1,-t,-i,c),this.UnmakeMove(B),g>n){if(n=g,g>i){if(M=B,P&&(o.moves.length=0,o.moves.push(B),o.moves.push(...c.moves)),g>=t)return this.MoveIsCapture(B)||(this.search.killers[1][this.Position.Ply]=this.search.killers[0][this.Position.Ply],this.search.killers[0][this.Position.Ply]=B,this.search.history[this.Position.SideToMove][63&B][(4032&B)>>6]+=s*s),this.WriteTT(s,2,n,M),g;i=g,h=0}}else this.MoveIsCapture(B)||this.search.history[this.Position.SideToMove][63&B][(4032&B)>>6]>0&&(this.search.history[this.Position.SideToMove][63&B][(4032&B)>>6]-=1);c.moves.length=0}return 0===a?l?-this.Inf+this.Position.Ply:0:(this.WriteTT(s,h,n,M),n)}Quiescence(s,i,t){this.search.nodes++;let o=1;if(this.search.nodes%1e3==0&&this.CheckTime(),this.Timer.stop)return 0;const{ttScore:e,ttMove:n}=this.ProbeTT(0,s,i);if(e!==this.HashNoMove&&0!==this.Position.Ply)return e;let h=n,a=e,r=a;const P=this.IsSquareAttacked(this.GetLS1B(this.Position.PiecesBB[this.Position.SideToMove][5]),1^this.Position.SideToMove);if(P)a=-this.Inf,r=a;else{if(a===this.HashNoMove&&(a=this.Evaluate()),a>=i)return a;a>s&&(s=a),r=a+150}let l=this.GenerateMoves(!0);l=this.SortMoves(l,h);for(let e=0;e<l.length;e++){const n=l[e];if(!P&&!this.MoveIsPromotion(n)){const i=r+this.EGPieceValue[this.Position.Squares[(4032&n)>>6]?.Type??0];if(i<=s){a<i&&(a=i);continue}}if(this.See(n)<0)continue;if(!this.MakeMove(n)){this.UnmakeMove(n);continue}let c=-this.Quiescence(-i,-s,t-1);if(this.UnmakeMove(n),c>a&&(a=c,h=n),c>=i)return this.WriteTT(0,2,a,h),a;c>s&&(o=0,s=c)}return P&&a===-this.Inf?-this.Inf+this.Position.Ply:(this.WriteTT(0,o,a,h),a)}IsRepetition(){for(let s=this.PositionHistory.length-this.Position.HalfMoves;s<this.PositionHistory.length-1;s++)if(this.PositionHistory[s]===this.Position.Hash)return!0;return!1}AgeHistory(){for(let i=s.a8;i<=s.h1;i++)for(let t=s.a8;t<=s.h1;t++)this.search.history[this.Position.SideToMove][i][t]/=2}SortMoves(s,i){const t=[];for(let o=0;o<s.length;o++){const e=s[o];if(e===i)t.push({move:e,score:this.Inf});else if(this.MoveIsCapture(e)){const s=this.Position.Squares[63&e];let i=this.Position.Squares[(4032&e)>>6];(16256&e)>>12==2&&(i=this.Position.Squares[0===this.Position.SideToMove?8+((4032&e)>>6):((4032&e)>>6)-8]);const o=this.MGPieceValue[i.Type]-s.Type+1e4;t.push({move:e,score:o})}else e===this.search.killers[0][this.Position.Ply]?t.push({move:e,score:9e3}):e===this.search.killers[1][this.Position.Ply]?t.push({move:e,score:8e3}):t.push({move:e,score:this.search.history[this.Position.SideToMove][63&e][(4032&e)>>6]})}const o=t.length;for(let s=1;s<o;s++){let i=t[s],o=s-1;for(;o>-1&&i.score>t[o].score;)t[o+1]=t[o],o--;t[o+1]=i}return t.map((({move:s})=>s))}See(s){const i=(4032&s)>>6,t=63&s,o=this.Position.Squares[t].Type;let e=this.Position.Squares[i]?.Type,n=1^this.Position.SideToMove;if(void 0===e)return 0;const h=[];let a=0,r=this.SetBit(0n,t),P=this.AttacksTo(i),l=0n;const c=this.Position.PiecesBB[0][0]|this.Position.PiecesBB[0][2]|this.Position.PiecesBB[0][3]|this.Position.PiecesBB[0][4]|this.Position.PiecesBB[1][0]|this.Position.PiecesBB[1][2]|this.Position.PiecesBB[1][3]|this.Position.PiecesBB[1][4];for(h[a]=this.MGPieceValue[e];r&&(a++,h[a]=this.MGPieceValue[o]-h[a-1],!(Math.max(-h[a-1],h[a])<0));){P^=r,l|=r,r&c&&(P|=this.ConsiderXRays(i)&~l);const{bitboard:s,piece:t}=this.GetLeastValuablePiece(P,n,e);r=s,e=t,n^=1}for(;--a;)h[a-1]=-Math.max(-h[a-1],h[a]);return h[0]}AttacksTo(s){const i=this.Position.PiecesBB[0][0]&this.PawnAttacks[1][s]|this.Position.PiecesBB[1][0]&this.PawnAttacks[0][s],t=(this.Position.PiecesBB[0][1]|this.Position.PiecesBB[1][1])&this.KnightAttacks[s],o=(this.Position.PiecesBB[0][5]|this.Position.PiecesBB[1][5])&this.KingAttacks[s],e=this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1];let n=this.Position.PiecesBB[0][2]|this.Position.PiecesBB[1][2]|this.Position.PiecesBB[0][4]|this.Position.PiecesBB[1][4];n&=this.GenerateBishopAttacks(e,s);let h=this.Position.PiecesBB[0][3]|this.Position.PiecesBB[1][3]|this.Position.PiecesBB[0][4]|this.Position.PiecesBB[1][4];return h&=this.GenerateRookAttacks(e,s),i|t|o|n|h}ConsiderXRays(s){const i=this.Position.OccupanciesBB[0]|this.Position.OccupanciesBB[1];let t=this.Position.PiecesBB[0][2]|this.Position.PiecesBB[1][2]|this.Position.PiecesBB[0][4]|this.Position.PiecesBB[1][4];t&=this.GenerateBishopAttacks(i,s);let o=this.Position.PiecesBB[0][3]|this.Position.PiecesBB[1][3]|this.Position.PiecesBB[0][4]|this.Position.PiecesBB[1][4];return o&=this.GenerateRookAttacks(i,s),t|o}GetLeastValuablePiece(s,i,t){for(t=0;t<=5;t++){let o=s&this.Position.PiecesBB[i][t];if(o)return{bitboard:o&-o,piece:t}}return{bitboard:0n,piece:0}}StartTimer(){let s=0;if(this.Timer.stop=!1,-1!==this.Timer.timeleft||-1!==this.Timer.movetime){if(0!==this.Timer.movestogo)s=this.Timer.timeleft/this.Timer.movestogo;else if(-1!==this.Timer.movetime)s=this.Timer.movetime;else{let i=0;i=this.Position.Ply<=20?45-this.Position.Ply:25,s=this.Timer.timeleft/i}s+=this.Timer.increment/2,s>=this.Timer.timeleft&&(s-=this.Timer.increment),s<=0&&(s=this.Timer.increment-1),this.Timer.startTime=Date.now(),this.Timer.stopTime=this.Timer.startTime+s}}CheckTime(){(this.Timer.stop||-1!==this.Timer.timeleft||-1!==this.Timer.movetime)&&Date.now()>this.Timer.stopTime&&(this.Timer.stop=!0)}ParseUCIPosition(s){const i=s.split(" ").slice(1).join(" ");i.startsWith("fen")?this.LoadFEN(i.split(" ").slice(1).join(" ")):this.LoadFEN(o.positions.start);const t=i.split("moves ").slice(1).join(" ").split(" ").filter((s=>""!=s));for(let i=0;i<t.length;i++){const o=this.ParseUCIMove(t[i]);if(!o){console.error("Unable to parse UCI command"),console.log(`Command: ${s}`),console.log(`Invalid move: ${t[i]}`);break}this.MakeMove(o)}}ParseUCIMove(i){const t=parseInt(i.charAt(0),36)-10,o=8*(7-(parseInt(i.charAt(1))-1))+t,e=parseInt(i.charAt(2),36)-10;let n=8*(7-(parseInt(i.charAt(3))-1))+e;const h=this.Position.Squares[o];let a=0,r=0;if(5===i.length){const s=i.charAt(4);a=1,"n"===s?r=0:"b"===s?r=1:"r"===s?r=2:"q"===s&&(r=3)}return 5===h.Type?this.isChess960||"e1g1"!==i&&"e1c1"!==i&&"e8g8"!==i&&"e8c8"!==i?(n===this.Position.CastlingRookSquares[1]&&1&this.Position.CastlingRights||n===this.Position.CastlingRookSquares[4]&&4&this.Position.CastlingRights||n===this.Position.CastlingRookSquares[2]&&2&this.Position.CastlingRights||n===this.Position.CastlingRookSquares[8]&&8&this.Position.CastlingRights)&&(a=3):(a=3,n=(n>o?s.h1:s.a1)^56*h.Color):n===this.Position.EnPassSq&&0===h.Type&&(a=2),this.EncodeMove(o,n,a,r)}ParseUCIGo(s){const i=s.split(" "),t=0===this.Position.SideToMove?"w":"b";let o=-1,e=0,n=0,h=-1,a=this.MaxPly;for(let s=0;s<i.length;s++){const r=i[s];r===t+"time"?o=parseInt(i[s+1]):r===t+"inc"?e=parseInt(i[s+1]):"movestogo"===r?n=parseInt(i[s+1]):"depth"===r?a=Math.min(parseInt(i[s+1]),this.MaxPly):"movetime"===r&&(h=parseInt(i[s+1]))}return this.Timer.timeleft=o,this.Timer.increment=e,this.Timer.depth=a,this.Timer.movestogo=n,this.Timer.movetime=h,this.Search(a)}Perft(s,i=!1){this.totalNodes=0;const t=performance.now(),o=this.GenerateMoves();for(let t=0;t<o.length;t++){const e=o[t];if(this.MakeMove(e)){let t=this.PerftDriver(s-1);i&&console.log(`${this.PrettyPrintMove(e)}: ${t}`)}this.UnmakeMove(e)}const e=performance.now();return i&&console.log(`Nodes: ${this.totalNodes.toLocaleString()}. Time taken: ${e-t}`),this.totalNodes}PerftDriver(s){let i=0;if(0===s)return this.totalNodes++,1;const t=this.GenerateMoves();for(let o=0;o<t.length;o++){const e=t[o];this.MakeMove(e)&&(i+=this.PerftDriver(s-1)),this.UnmakeMove(e)}return i}}o.positions={empty:"8/8/8/8/8/8/8/8 b - - ",start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",kiwipete:"r3k2r/p1ppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q1p/PPPBBPPP/R3K2R w KQkq -",pos3:"8/2p5/3p4/KP5r/1R3p1k/8/4P1P1/8 w - -",pos4w:"r3k2r/Pppp1ppp/1b3nbN/nP6/BBP1P3/q4N2/Pp1P2PP/R2Q1RK1 w kq - 0 1",pos4b:"r2q1rk1/pP1p2pp/Q4n2/bbp1p3/Np6/1B3NBn/pPPP1PPP/R3K2R b KQ - 0 1",pos5:"rnbq1k1r/pp1Pbppp/2p5/8/2B5/8/PPP1NnPP/RNBQK2R w KQ - 1 8",pos6:"r4rk1/1pp1qppp/p1np1n2/2b1p1B1/2B1P1b1/P1NP1N2/1PP1QPPP/R4RK1 w - - 0 10"};const e=o;Engine=t.default})();